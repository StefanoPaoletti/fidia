<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Prezzi Fidia - Pro Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.263.0/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
 
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
     
        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ];
        
        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];
        
        const SHEET_ID = '1FvExAXdbcPeA3vowfpVm1D4IO68GYF4s5GpzesvAJu8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwEws6PFs5lkvbmYJrBkpTNs29LrmCSF0xaVUfwHBrO4FcOjCKIPBQmMxPZzvmMs7x/exec';
        
        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [isLoading, setIsLoading] = useState(false);
          
          // Form fattura
          const [invoiceDate, setInvoiceDate] = useState('');
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [shippingCost, setShippingCost] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([
            { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }
          ]);
          const [editingInvoice, setEditingInvoice] = useState(null);
          
          // Form nota credito
          const [creditDate, setCreditDate] = useState(new Date().toISOString().split('T')[0]);
          const [creditAmount, setCreditAmount] = useState('');
          
          // Timer per prezzi online
          const priceTimerRef = useRef(null);
          
          // Chart refs
          const marginChartRef = useRef(null);
          const costChartRef = useRef(null);
          
          useEffect(() => {
            const stored = localStorage.getItem('fidiaAppPassword');
            if (stored) {
              setSavedPassword(stored);
              setIsAuthenticated(true);
              loadFromGoogleSheets(stored);
            }
          }, []);
          
          useEffect(() => {
            if (activeTab === 'dashboard') {
              drawCharts();
            }
          }, [activeTab, analysis, selectedYear]);
          
          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              if (!response.ok) throw new Error('Errore server');
              const data = await response.json();
              
              const invoiceMap = {};
              (data.invoices || []).forEach(row => {
                if (!invoiceMap[row.id]) {
                  let dateStr = row.date;
                  if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    dateStr = dateStr.split('T')[0];
                  }
                  
                  invoiceMap[row.id] = {
                    id: row.id,
                    year: row.year,
                    date: dateStr,
                    number: row.number,
                    shippingCost: row.shippingCost || 0,
                    items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product,
                  quantity: row.quantity,
                  priceGross: row.priceGross,
                  priceNet: row.priceNet,
                  discount: row.discount || 0,
                  vat: row.vat,
                  freebies: row.freebies
                });
              });
              
              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes || []);
              setOnlinePrices(data.onlinePrices || {});
            } catch (error) {
              console.error('Errore caricamento:', error);
              alert('Errore nel caricamento dei dati');
            }
            setIsLoading(false);
          };
          
          const saveToGoogleSheets = async (action, payload) => {
            if (!savedPassword) return false;
            setIsLoading(true);
            try {
              await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: savedPassword, action, ...payload }),
                mode: 'no-cors'
              });
              
              await new Promise(r => setTimeout(r, 1500));
              await loadFromGoogleSheets();
              return true;
            } catch (error) {
              console.error(error);
              alert('Errore salvataggio: ' + error.message);
              setIsLoading(false);
              return false;
            }
          };
          
          const handleLogin = () => {
            if (!password) return alert('Inserisci la password!');
            localStorage.setItem('fidiaAppPassword', password);
            setSavedPassword(password);
            setIsAuthenticated(true);
            loadFromGoogleSheets(password);
          };
          
          const handleLogout = () => {
            localStorage.removeItem('fidiaAppPassword');
            setSavedPassword('');
            setIsAuthenticated(false);
            setPassword('');
            setInvoices([]);
            setCreditNotes([]);
            setOnlinePrices({});
          };
          
          const addInvoiceItem = () => setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          const removeInvoiceItem = index => setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
          const updateInvoiceItem = (index, field, value) => {
            const updated = [...invoiceItems];
            updated[index][field] = value;
            setInvoiceItems(updated);
          };
          
          const resetForm = () => {
            setEditingInvoice(null);
            setInvoiceDate('');
            setInvoiceNumber('');
            setShippingCost('');
            setInvoiceItems([{ product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          };
          
          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');
            
            const shipping = parseFloat(shippingCost) || 0;
            const year = new Date(invoiceDate).getFullYear().toString();
            
            const newInvoice = {
              id: Date.now(),
              date: invoiceDate,
              number: invoiceNumber,
              year: year,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };
            
            const success = await saveToGoogleSheets('saveInvoice', newInvoice);
            if (success) {
              resetForm();
              alert('Fattura salvata con successo!');
            }
          };
          
          const updateInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');
            
            const shipping = parseFloat(shippingCost) || 0;
            const year = new Date(invoiceDate).getFullYear().toString();
            
            const updatedInvoice = {
              id: editingInvoice.id,
              date: invoiceDate,
              number: invoiceNumber,
              year: year,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };
            
            const success = await saveToGoogleSheets('updateInvoice', updatedInvoice);
            if (success) {
              resetForm();
              alert('Fattura aggiornata con successo!');
            }
          };
          
          const deleteInvoice = async (id) => {
            if (!confirm('Eliminare definitivamente questa fattura?')) return;
            await saveToGoogleSheets('deleteInvoice', { id });
          };
          
          const startEditInvoice = (invoice) => {
            setEditingInvoice(invoice);
            setInvoiceDate(invoice.date);
            setInvoiceNumber(invoice.number);
            setShippingCost(invoice.shippingCost || '');
            setInvoiceItems(invoice.items.map(item => ({
              product: item.product,
              quantity: item.quantity,
              price: item.priceGross,
              discount: item.discount || '',
              vat: item.vat || '10',
              freebies: item.freebies || ''
            })));
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          const saveCreditNote = async () => {
            if (!creditAmount || parseFloat(creditAmount) <= 0) return alert('Inserisci un importo valido');
            const year = new Date(creditDate).getFullYear();
            const newNote = {
              id: Date.now(),
              year: year,
              date: creditDate,
              amount: parseFloat(creditAmount)
            };
            const success = await saveToGoogleSheets('saveCreditNote', newNote);
            if (success) {
              setCreditAmount('');
              setCreditDate(new Date().toISOString().split('T')[0]);
              alert('Nota di credito salvata!');
            }
          };
          
          const deleteCreditNote = async (id) => {
            if (!confirm('Eliminare questa nota di credito?')) return;
            await saveToGoogleSheets('deleteCreditNote', { id });
          };
          
          const handlePriceChange = (product, value) => {
            const newPrices = { ...onlinePrices, [product]: parseFloat(value) || 0 };
            setOnlinePrices(newPrices);
            if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
            priceTimerRef.current = setTimeout(() => {
              if (value !== '') {
                saveToGoogleSheets('saveOnlinePrice', { product, price: parseFloat(value) || 0 });
              }
            }, 2000);
          };
          
          const exportDashboardImage = async () => {
            const el = document.getElementById('dashboard-content');
            if (!el) return alert('Errore: contenuto non trovato');
            try {
              const canvas = await html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });
              const link = document.createElement('a');
              link.download = `analisi-margini-${selectedYear}-${new Date().toISOString().split('T')[0]}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            } catch (err) {
              alert('Errore esportazione immagine');
            }
          };
          
          // Analisi ottimizzata
          const analysis = useMemo(() => {
            const result = {};
            const yearData = {};
            
            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQuantity = 0;
              let yearCost = {};
              let yearQuantity = {};
              
              const filteredInvoices = selectedYear === 'all'
                ? invoices
                : invoices.filter(inv => String(inv.year) === selectedYear);
              
              filteredInvoices.forEach(invoice => {
                const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                const shipping = parseFloat(invoice.shippingCost) || 0;
                
                invoice.items.forEach(item => {
                  if (item.product !== product) return;
                  
                  const qty = parseFloat(item.quantity) || 0;
                  const free = parseFloat(item.freebies) || 0;
                  const netPrice = parseFloat(item.priceNet || item.price) || 0;
                  const vat = parseFloat(item.vat) || 0;
                  const totalQty = qty + free;
                  
                  const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                  const priceWithVAT = qty * netPrice * (1 + vat / 100);
                  const shippingWithVAT = shippingShare * 1.22;
                  const itemCost = priceWithVAT + shippingWithVAT;
                  
                  totalCost += itemCost;
                  totalQuantity += totalQty;
                  
                  if (!yearCost[invoice.year]) yearCost[invoice.year] = 0;
                  if (!yearQuantity[invoice.year]) yearQuantity[invoice.year] = 0;
                  yearCost[invoice.year] += itemCost;
                  yearQuantity[invoice.year] += totalQty;
                  
                  // Accumula per grafici
                  if (!yearData[invoice.year]) yearData[invoice.year] = { cost: 0, margin: 0, qty: 0, products: 0 };
                  yearData[invoice.year].cost += itemCost;
                  yearData[invoice.year].qty += totalQty;
                  yearData[invoice.year].products += 1;
                });
              });
              
              // Note di credito
              const relevantCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(c => String(c.year) === selectedYear);
              
              relevantCredits.forEach(c => {
                const creditYear = String(c.year);
                if (yearCost[creditYear]) {
                  let totalYearCost = 0;
                  PRODUCTS.forEach(p => {
                    filteredInvoices.forEach(invoice => {
                      if (String(invoice.year) !== creditYear) return;
                      
                      const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                      const shipping = parseFloat(invoice.shippingCost) || 0;
                      
                      invoice.items.forEach(item => {
                        if (item.product !== p) return;
                        const qty = parseFloat(item.quantity) || 0;
                        const free = parseFloat(item.freebies) || 0;
                        const netPrice = parseFloat(item.priceNet || item.price) || 0;
                        const vat = parseFloat(item.vat) || 0;
                        const totalQty = qty + free;
                        const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                        const priceWithVAT = qty * netPrice * (1 + vat / 100);
                        const shippingWithVAT = shippingShare * 1.22;
                        totalYearCost += priceWithVAT + shippingWithVAT;
                      });
                    });
                  });
                  
                  if (totalYearCost > 0) {
                    const prop = yearCost[creditYear] / totalYearCost;
                    yearCost[creditYear] -= c.amount * prop;
                  }
                }
              });
              
              const finalCost = Object.values(yearCost).reduce((a, b) => a + b, 0);
              const avgCost = totalQuantity > 0 ? finalCost / totalQuantity : 0;
              const online = onlinePrices[product] || 0;
              const margin = online > 0 ? ((online - avgCost) / online) * 100 : 0;
              
              result[product] = { avgRealCost: avgCost, onlinePrice: online, margin, totalQuantity, yearCost, yearQuantity };
            });
            
            // Calcola margini per anno per grafici
            Object.keys(yearData).forEach(year => {
              const totalRevenue = PRODUCTS.reduce((sum, p) => sum + (result[p].yearQuantity[year] || 0) * (onlinePrices[p] || 0), 0);
              const totalCost = PRODUCTS.reduce((sum, p) => sum + (result[p].yearCost[year] || 0), 0);
              yearData[year].margin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue) * 100 : 0;
            });
            
            return { products: result, years: yearData };
          }, [invoices, creditNotes, onlinePrices, selectedYear]);
          
          const drawCharts = () => {
            // Margin Chart
            if (marginChartRef.current) marginChartRef.current.destroy();
            const marginCtx = document.getElementById('marginChart').getContext('2d');
            marginChartRef.current = new Chart(marginCtx, {
              type: 'bar',
              data: {
                labels: Object.keys(analysis.years).sort(),
                datasets: [{
                  label: 'Margine Medio %',
                  data: Object.values(analysis.years).map(y => y.margin.toFixed(1)),
                  backgroundColor: 'rgba(59, 130, 246, 0.6)',
                  borderColor: 'rgb(59, 130, 246)',
                  borderWidth: 1
                }]
              },
              options: {
                animation: { duration: 1000, easing: 'easeOutQuart' },
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { legend: { display: false } }
              }
            });
            
            // Cost Chart
            if (costChartRef.current) costChartRef.current.destroy();
            const costCtx = document.getElementById('costChart').getContext('2d');
            costChartRef.current = new Chart(costCtx, {
              type: 'line',
              data: {
                labels: Object.keys(analysis.years).sort(),
                datasets: [{
                  label: 'Costo Medio €',
                  data: Object.values(analysis.years).map(y => (y.cost / y.qty || 0).toFixed(2)),
                  borderColor: 'rgb(245, 158, 11)',
                  tension: 0.4,
                  fill: true,
                  backgroundColor: 'rgba(245, 158, 11, 0.2)'
                }]
              },
              options: {
                animation: { duration: 1000, easing: 'easeOutQuart' },
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
              }
            });
          };
          
          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-500 to-indigo-700 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all duration-500 ease-in-out animate-fadeIn">
                  <h1 className="text-3xl font-bold text-gray-900 mb-6 text-center flex items-center justify-center gap-2">
                    <i data-lucide="activity" className="w-8 h-8 text-blue-600"></i>
                    Analisi Prezzi Fidia
                  </h1>
                  <div className="space-y-6">
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                        onKeyPress={e => e.key === 'Enter' && handleLogin()}
                        placeholder="Inserisci password"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                      />
                      <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-600 hover:text-gray-800 transition-colors">
                        <i data-lucide={showPassword ? 'eye' : 'eye-off'} className="w-5 h-5"></i>
                      </button>
                    </div>
                    <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all transform hover:scale-105">
                      Accedi Sicuro
                    </button>
                  </div>
                </div>
              </div>
            );
          }
          
          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-2xl p-8 flex items-center gap-4 shadow-2xl animate-fadeIn">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
                    <span className="text-xl font-medium text-gray-900">Sincronizzazione in corso...</span>
                  </div>
                </div>
              )}
              
              <header className="bg-white shadow-md sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                      <i data-lucide="bar-chart-3" className="w-6 h-6 text-blue-600"></i>
                      Analisi Fidia Pro
                    </h1>
                    <div className="flex gap-3 items-center">
                      <button onClick={loadFromGoogleSheets} disabled={isLoading} className="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Ricarica">
                        <i data-lucide="refresh-cw" className="w-5 h-5 text-blue-600"></i>
                      </button>
                      <a href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`} target="_blank" className="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Apri Sheets">
                        <i data-lucide="sheet" className="w-5 h-5 text-green-600"></i>
                      </a>
                      <button onClick={handleLogout} className="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Logout">
                        <i data-lucide="log-out" className="w-5 h-5 text-red-600"></i>
                      </button>
                    </div>
                  </div>
                  <nav className="flex gap-2 mt-4 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300">
                    {['dashboard', 'invoices', 'credits', 'prices'].map(tab => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-6 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                          activeTab === tab 
                            ? 'bg-blue-600 text-white shadow-md scale-105' 
                            : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'
                        }`}
                      >
                        {tab === 'dashboard' ? 'Dashboard' : tab === 'invoices' ? 'Fatture' : tab === 'credits' ? 'Note Credito' : 'Prezzi Online'}
                      </button>
                    ))}
                  </nav>
                </div>
              </header>
              
              <main className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                {/* DASHBOARD */}
                {activeTab === 'dashboard' && (
                  <div id="dashboard-content" className="space-y-8">
                    <div className="flex justify-between items-center animate-fadeIn">
                      <h2 className="text-3xl font-bold text-gray-900">Analisi Margini</h2>
                      <div className="flex gap-3">
                        <select 
                          value={selectedYear} 
                          onChange={e => setSelectedYear(e.target.value)} 
                          className="px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 transition-all"
                        >
                          <option value="all">Tutti gli anni</option>
                          {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                        <button 
                          onClick={exportDashboardImage} 
                          className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all flex items-center gap-2"
                        >
                          <i data-lucide="download" className="w-4 h-4"></i>
                          Esporta
                        </button>
                      </div>
                    </div>
                    
                    {/* CARDS */}
                    {(() => {
                      const activeProducts = Object.entries(analysis.products).filter(([, d]) => d.totalQuantity > 0);
                      const revenue = activeProducts.reduce((s, [, d]) => s + d.onlinePrice * d.totalQuantity, 0);
                      const cost = activeProducts.reduce((s, [, d]) => s + d.avgRealCost * d.totalQuantity, 0);
                      const weightedMargin = revenue > 0 ? ((revenue - cost) / revenue) * 100 : 0;
                      
                      const filtered = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
                      let totalFree = 0, totalFreeValue = 0, totalPurchaseValue = 0;
                      
                      filtered.forEach(inv => {
                        inv.items.forEach(item => {
                          const qty = parseFloat(item.quantity) || 0;
                          const free = parseFloat(item.freebies) || 0;
                          const net = parseFloat(item.priceNet || item.price) || 0;
                          const vat = parseFloat(item.vat) || 0;
                          const priceIVA = net * (1 + vat / 100);
                          totalFree += free;
                          totalFreeValue += free * priceIVA;
                          totalPurchaseValue += qty * priceIVA;
                        });
                      });
                      
                      const percOmaggi = totalPurchaseValue > 0 ? (totalFreeValue / totalPurchaseValue) * 100 : 0;
                      
                      return (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 animate-fadeIn">
                          <div className={`bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-all transform hover:-translate-y-1`}>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-600 mb-2">
                              <i data-lucide="dollar-sign" className="w-4 h-4"></i>
                              Stima Incasso
                            </div>
                            <div className="text-3xl font-bold text-blue-600">€ {revenue.toFixed(2)}</div>
                          </div>
                          
                          <div className={`bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500 hover:shadow-lg transition-all transform hover:-translate-y-1`}>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-600 mb-2">
                              <i data-lucide="shopping-cart" className="w-4 h-4"></i>
                              Costo Totale
                            </div>
                            <div className="text-3xl font-bold text-orange-600">€ {cost.toFixed(2)}</div>
                          </div>
                          
                          <div className={`bg-white rounded-xl shadow-md p-6 border-l-4 ${
                            weightedMargin < 20 ? 'border-red-500' : weightedMargin < 30 ? 'border-yellow-500' : 'border-green-500'
                          } hover:shadow-lg transition-all transform hover:-translate-y-1`}>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-600 mb-2">
                              <i data-lucide="trending-up" className="w-4 h-4"></i>
                              Margine Medio
                            </div>
                            <div className={`text-3xl font-bold ${
                              weightedMargin < 20 ? 'text-red-600' : weightedMargin < 30 ? 'text-yellow-600' : 'text-green-600'
                            }`}>
                              {weightedMargin.toFixed(1)}%
                            </div>
                          </div>
                          
                          {totalFree > 0 && (
                            <div className={`bg-white rounded-xl shadow-md p-6 border-l-4 border-emerald-500 hover:shadow-lg transition-all transform hover:-translate-y-1`}>
                              <div className="flex items-center gap-2 text-sm font-medium text-gray-600 mb-2">
                                <i data-lucide="gift" className="w-4 h-4"></i>
                                Omaggi
                              </div>
                              <div className="text-3xl font-bold text-emerald-600">{percOmaggi.toFixed(1)}%</div>
                              <div className="text-xs text-gray-500 mt-1">
                                {totalFree} pz • € {totalFreeValue.toFixed(2)}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                    
                    {/* GRAFICI */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fadeIn">
                      <div className="bg-white rounded-xl shadow-md p-6">
                        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                          <i data-lucide="bar-chart-2" className="w-5 h-5 text-blue-600"></i>
                          Margini per Anno
                        </h3>
                        <canvas id="marginChart" className="w-full h-64"></canvas>
                      </div>
                      <div className="bg-white rounded-xl shadow-md p-6">
                        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                          <i data-lucide="line-chart" className="w-5 h-5 text-orange-600"></i>
                          Costi Medi per Anno
                        </h3>
                        <canvas id="costChart" className="w-full h-64"></canvas>
                      </div>
                    </div>
                    
                    {/* TABELLA */}
                    <div className="bg-white rounded-xl shadow-md overflow-hidden animate-fadeIn">
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-6 py-4 text-left font-semibold text-gray-900">Prodotto</th>
                              <th className="px-6 py-4 text-right font-semibold text-gray-900">Costo Reale €</th>
                              <th className="px-6 py-4 text-right font-semibold text-gray-900">Prezzo Online €</th>
                              <th className="px-6 py-4 text-right font-semibold text-gray-900">Margine %</th>
                              <th className="px-6 py-4 text-right font-semibold text-gray-900">Qtà Totale</th>
                              <th className="px-6 py-4 text-center font-semibold text-gray-900">Status</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {Object.entries(analysis.products)
                              .filter(([, d]) => d.totalQuantity > 0)
                              .sort(([, a], [, b]) => a.margin - b.margin)
                              .map(([product, data]) => (
                                <tr key={product} className="hover:bg-gray-50 transition-colors">
                                  <td className="px-6 py-4 font-medium text-gray-900">{product}</td>
                                  <td className="px-6 py-4 text-right">{data.avgRealCost.toFixed(2)}</td>
                                  <td className="px-6 py-4 text-right">{data.onlinePrice.toFixed(2)}</td>
                                  <td className={`px-6 py-4 text-right font-bold ${
                                    data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'
                                  }`}>
                                    {data.margin.toFixed(1)}%
                                  </td>
                                  <td className="px-6 py-4 text-right">{data.totalQuantity}</td>
                                  <td className="px-6 py-4 text-center">
                                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                      data.margin < 20 ? 'bg-red-100 text-red-700' : data.margin < 30 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'
                                    }`}>
                                      {data.margin < 20 ? 'Basso' : data.margin < 30 ? 'Medio' : 'Buono'}
                                    </span>
                                  </td>
                                </tr>
                              ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* FATTURE */}
                {activeTab === 'invoices' && (
                  <div className="space-y-8">
                    <div className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                      <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide={editingInvoice ? 'edit' : 'file-plus'} className="w-6 h-6 text-blue-600"></i>
                        {editingInvoice ? 'Modifica Fattura' : 'Nuova Fattura'}
                      </h2>
                      
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Data Fattura</label>
                          <input 
                            type="date" 
                            value={invoiceDate} 
                            onChange={e => setInvoiceDate(e.target.value)} 
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Numero Fattura</label>
                          <input 
                            type="text" 
                            value={invoiceNumber} 
                            onChange={e => setInvoiceNumber(e.target.value)} 
                            placeholder="es. 3060003884" 
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Spese Spedizione €</label>
                          <input 
                            type="number" 
                            step="0.01" 
                            value={shippingCost} 
                            onChange={e => setShippingCost(e.target.value)} 
                            placeholder="0.00" 
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                          />
                        </div>
                      </div>
                      
                      {shippingCost && parseFloat(shippingCost) > 0 && (
                        <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 flex items-start gap-2 text-sm">
                          <i data-lucide="info" className="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                          Le spese di spedizione (€{parseFloat(shippingCost).toFixed(2)}) saranno ripartite proporzionalmente (IVA 22%).
                        </div>
                      )}
                      
                      <div className="overflow-x-auto mb-6 rounded-lg border border-gray-200">
                        <table className="w-full text-sm divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">Qtà</th>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">Prodotto</th>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">Prezzo €</th>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">Sconto %</th>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">IVA %</th>
                              <th className="px-4 py-3 text-left font-semibold text-gray-900">Omaggi</th>
                              <th className="px-4 py-3"></th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {invoiceItems.map((item, i) => (
                              <tr key={i} className="hover:bg-gray-50 transition-colors">
                                <td className="px-4 py-3">
                                  <input 
                                    type="number" 
                                    value={item.quantity} 
                                    onChange={e => updateInvoiceItem(i, 'quantity', e.target.value)} 
                                    placeholder="24"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                  />
                                </td>
                                <td className="px-4 py-3">
                                  <select 
                                    value={item.product} 
                                    onChange={e => updateInvoiceItem(i, 'product', e.target.value)} 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  >
                                    <option value="">Seleziona...</option>
                                    {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                                  </select>
                                </td>
                                <td className="px-4 py-3">
                                  <input 
                                    type="number" 
                                    step="0.01" 
                                    value={item.price} 
                                    onChange={e => updateInvoiceItem(i, 'price', e.target.value)} 
                                    placeholder="9.46" 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                  />
                                </td>
                                <td className="px-4 py-3">
                                  <input 
                                    type="number" 
                                    step="0.01" 
                                    value={item.discount} 
                                    onChange={e => updateInvoiceItem(i, 'discount', e.target.value)} 
                                    placeholder="0" 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                  />
                                </td>
                                <td className="px-4 py-3">
                                  <select 
                                    value={item.vat} 
                                    onChange={e => updateInvoiceItem(i, 'vat', e.target.value)} 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  >
                                    <option value="10">10%</option>
                                    <option value="22">22%</option>
                                  </select>
                                </td>
                                <td className="px-4 py-3">
                                  <input 
                                    type="number" 
                                    value={item.freebies} 
                                    onChange={e => updateInvoiceItem(i, 'freebies', e.target.value)} 
                                    placeholder="0" 
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                  />
                                </td>
                                <td className="px-4 py-3 text-center">
                                  <button 
                                    onClick={() => removeInvoiceItem(i)} 
                                    className="text-red-600 hover:text-red-800 transition-colors"
                                  >
                                    <i data-lucide="trash-2" className="w-5 h-5"></i>
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      
                      <div className="flex flex-wrap gap-3">
                        <button 
                          onClick={addInvoiceItem} 
                          className="px-5 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all flex items-center gap-2"
                        >
                          <i data-lucide="plus" className="w-4 h-4"></i>
                          Aggiungi Riga
                        </button>
                        {editingInvoice ? (
                          <>
                            <button 
                              onClick={updateInvoice} 
                              disabled={isLoading} 
                              className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all flex items-center gap-2"
                            >
                              <i data-lucide="save" className="w-4 h-4"></i>
                              Aggiorna
                            </button>
                            <button 
                              onClick={resetForm} 
                              className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2"
                            >
                              <i data-lucide="x" className="w-4 h-4"></i>
                              Annulla
                            </button>
                          </>
                        ) : (
                          <button 
                            onClick={saveInvoice} 
                            disabled={isLoading} 
                            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2"
                          >
                            <i data-lucide="save" className="w-4 h-4"></i>
                            Salva Fattura
                          </button>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                      <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="files" className="w-6 h-6 text-indigo-600"></i>
                        Fatture Inserite ({invoices.length})
                      </h2>
                      <div className="space-y-4">
                        {invoices.slice().sort((a, b) => b.date.localeCompare(a.date)).map(inv => (
                          <div key={inv.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
                            <div className="flex justify-between items-start mb-2">
                              <div className="font-bold text-lg text-gray-900">{inv.number} - {inv.date} ({inv.year})</div>
                              <div className="flex gap-2">
                                <button 
                                  onClick={() => startEditInvoice(inv)} 
                                  disabled={isLoading} 
                                  className="text-blue-600 hover:text-blue-800 transition-colors"
                                >
                                  <i data-lucide="edit" className="w-5 h-5"></i>
                                </button>
                                <button 
                                  onClick={() => deleteInvoice(inv.id)} 
                                  disabled={isLoading} 
                                  className="text-red-600 hover:text-red-800 transition-colors"
                                >
                                  <i data-lucide="trash-2" className="w-5 h-5"></i>
                                </button>
                              </div>
                            </div>
                            {inv.shippingCost > 0 && <div className="text-sm text-gray-600 mb-2">Spese spedizione: €{inv.shippingCost.toFixed(2)}</div>}
                            <div className="text-sm text-gray-700 space-y-1">
                              {inv.items.map((it, idx) => (
                                <div key={idx} className="flex items-center gap-2">
                                  <i data-lucide="package" className="w-4 h-4 text-gray-400"></i>
                                  {it.product}: {it.quantity} pz + {it.freebies || 0} omaggi @ €{it.priceGross} {it.discount > 0 && `(sconto ${it.discount}%)`}
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* NOTE DI CREDITO */}
                {activeTab === 'credits' && (
                  <div className="space-y-8">
                    <div className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                      <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="dollar-sign" className="w-6 h-6 text-green-600"></i>
                        Nuova Nota di Credito
                      </h2>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Data</label>
                          <input 
                            type="date" 
                            value={creditDate} 
                            onChange={e => setCreditDate(e.target.value)} 
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Importo €</label>
                          <input 
                            type="number" 
                            step="0.01" 
                            value={creditAmount} 
                            onChange={e => setCreditAmount(e.target.value)} 
                            placeholder="es. 250.00" 
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                          />
                        </div>
                      </div>
                      <button 
                        onClick={saveCreditNote} 
                        disabled={isLoading} 
                        className="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2"
                      >
                        <i data-lucide="save" className="w-4 h-4"></i>
                        Salva
                      </button>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                      <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="list" className="w-6 h-6 text-indigo-600"></i>
                        Note di Credito ({creditNotes.length})
                      </h2>
                      <div className="space-y-4">
                        {creditNotes.slice().sort((a, b) => {
                          const dateA = a.date || String(a.year);
                          const dateB = b.date || String(b.year);
                          return dateB.localeCompare(dateA);
                        }).map(note => (
                          <div key={note.id} className="border border-gray-200 rounded-lg p-4 flex justify-between items-center hover:shadow-md transition-all">
                            <div className="font-medium text-lg text-gray-900 flex items-center gap-2">
                              <i data-lucide="calendar" className="w-5 h-5 text-gray-500"></i>
                              {note.date || note.year} - € {note.amount.toFixed(2)}
                            </div>
                            <button 
                              onClick={() => deleteCreditNote(note.id)} 
                              disabled={isLoading} 
                              className="text-red-600 hover:text-red-800 transition-colors"
                            >
                              <i data-lucide="trash-2" className="w-5 h-5"></i>
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* PREZZI ONLINE */}
                {activeTab === 'prices' && (
                  <div className="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                      <i data-lucide="tag" className="w-6 h-6 text-purple-600"></i>
                      Prezzi Online
                    </h2>
                    <p className="text-gray-600 mb-6 flex items-center gap-2 text-sm">
                      <i data-lucide="info" className="w-4 h-4"></i>
                      I prezzi si salvano automaticamente dopo 2 secondi.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                      {PRODUCTS.map(product => (
                        <div key={product} className="flex items-center gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                          <label className="flex-1 text-sm font-medium text-gray-900 truncate">{product}</label>
                          <input
                            type="number"
                            step="0.01"
                            value={onlinePrices[product] || ''}
                            onChange={e => handlePriceChange(product, e.target.value)}
                            placeholder="0.00"
                            className="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            disabled={isLoading}
                          />
                          <span className="text-gray-500">€</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
        lucide.createIcons();
    </script>
</body>
</html>
