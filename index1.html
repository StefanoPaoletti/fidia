<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidia Analytics Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .sidebar-item-active { border-right: 4px solid #4f46e5; background: linear-gradient(90deg, rgba(79, 70, 229, 0.1) 0%, rgba(255, 255, 255, 0) 100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Estensione icone SVG in componenti
        const Icon = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" /></svg>,
            Invoice: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            Credit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12z" /></svg>,
            Price: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
        };

        const PRODUCTS = ['PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO', 'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO', 'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM', 'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL', 'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'].sort();
        const YEARS = ['2023', '2024', '2025', '2026'];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwEws6PFs5lkvbmYJrBkpTNs29LrmCSF0xaVUfwHBrO4FcOjCKIPBQmMxPZzvmMs7x/exec';

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [invoices, setInvoices] = useState([]);
            const [creditNotes, setCreditNotes] = useState([]);
            const [onlinePrices, setOnlinePrices] = useState({});
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Gestione dati (stessa logica del file precedente)
            useEffect(() => {
                const stored = localStorage.getItem('fidiaAppPassword');
                if (stored) { setIsAuthenticated(true); loadData(); }
            }, []);

            const loadData = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(SCRIPT_URL);
                    const data = await response.json();
                    
                    // Normalizzazione fatture (id unico)
                    const invMap = {};
                    (data.invoices || []).forEach(row => {
                        if(!invMap[row.id]) invMap[row.id] = {...row, items: []};
                        invMap[row.id].items.push(row);
                    });
                    
                    setInvoices(Object.values(invMap));
                    setCreditNotes(data.creditNotes || []);
                    setOnlinePrices(data.onlinePrices || {});
                } catch (e) { alert("Errore connessione"); }
                setIsLoading(false);
            };

            const analysis = useMemo(() => {
                const result = {};
                const filtered = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
                
                // Logica di calcolo ottimizzata (come suggerito prima)
                PRODUCTS.forEach(p => {
                    const prodInvoices = filtered.filter(inv => inv.items.some(it => it.product === p));
                    let totalQty = 0, totalCost = 0;

                    prodInvoices.forEach(inv => {
                        const row = inv.items.find(it => it.product === p);
                        const q = parseFloat(row.quantity) || 0;
                        const f = parseFloat(row.freebies) || 0;
                        const net = parseFloat(row.priceNet) || 0;
                        const vat = parseFloat(row.vat) || 10;
                        
                        totalQty += (q + f);
                        totalCost += (q * net * (1 + vat/100));
                    });

                    const avg = totalQty > 0 ? totalCost / totalQty : 0;
                    const online = onlinePrices[p] || 0;
                    result[p] = { 
                        avgRealCost: avg, 
                        onlinePrice: online, 
                        margin: online > 0 ? ((online - avg) / online) * 100 : 0,
                        totalQuantity: totalQty
                    };
                });
                return result;
            }, [invoices, onlinePrices, selectedYear]);

            const filteredAnalysis = Object.entries(analysis).filter(([name]) => 
                name.toLowerCase().includes(searchTerm.toLowerCase()) && analysis[name].totalQuantity > 0
            );

            if (!isAuthenticated) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full mb-4">
                                <Icon.Dashboard />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">Fidia Analytics</h1>
                            <p className="text-slate-500">Inserisci le credenziali per accedere</p>
                        </div>
                        <input 
                            type="password" 
                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none mb-4"
                            placeholder="Password di accesso"
                            onKeyDown={e => e.key === 'Enter' && (localStorage.setItem('fidiaAppPassword', e.target.value), setIsAuthenticated(true), loadData())}
                        />
                        <button 
                            onClick={() => { const p = document.querySelector('input').value; localStorage.setItem('fidiaAppPassword', p); setIsAuthenticated(true); loadData(); }}
                            className="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200"
                        >
                            Accedi al Sistema
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex">
                    {/* SIDEBAR */}
                    <aside className="w-64 bg-white border-r border-slate-200 hidden lg:flex flex-col fixed h-full">
                        <div className="p-6 border-b border-slate-100">
                            <h2 className="text-xl font-bold text-indigo-600">Fidia Pro</h2>
                            <p className="text-xs text-slate-400 font-medium">MANAGEMENT SYSTEM</p>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: <Icon.Dashboard /> },
                                { id: 'invoices', label: 'Fatture', icon: <Icon.Invoice /> },
                                { id: 'credits', label: 'Note Credito', icon: <Icon.Credit /> },
                                { id: 'prices', label: 'Prezzi Online', icon: <Icon.Price /> },
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all ${activeTab === item.id ? 'sidebar-item-active text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}
                                >
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-100">
                            <button onClick={() => {localStorage.clear(); location.reload();}} className="w-full text-left px-4 py-3 text-sm text-red-500 font-medium hover:bg-red-50 rounded-xl transition-all">
                                ðŸ”Œ Disconnetti
                            </button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 lg:ml-64 p-4 lg:p-10">
                        {isLoading && <div className="fixed top-0 left-0 w-full h-1 bg-indigo-600 animate-pulse z-50"></div>}
                        
                        {/* HEADER DASHBOARD */}
                        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <div>
                                <h1 className="text-2xl lg:text-3xl font-bold text-slate-800 tracking-tight">
                                    {activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}
                                </h1>
                                <p className="text-slate-500">Analisi e gestione dati in tempo reale</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select 
                                    value={selectedYear} 
                                    onChange={e => setSelectedYear(e.target.value)}
                                    className="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-medium shadow-sm outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                                <button onClick={loadData} className="p-2 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-slate-50">
                                    ðŸ”„
                                </button>
                            </div>
                        </header>

                        {/* DASHBOARD VIEW */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-in fade-in duration-500">
                                {/* STATS CARDS */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <p className="text-sm font-medium text-slate-500 mb-1">Margine Medio Periodo</p>
                                        <div className="flex items-end gap-2">
                                            <span className="text-3xl font-bold text-slate-900">28.4%</span>
                                            <span className="text-green-500 text-sm font-bold mb-1">â†‘ 2.1%</span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <p className="text-sm font-medium text-slate-500 mb-1">Volume Prodotti</p>
                                        <div className="flex items-end gap-2">
                                            <span className="text-3xl font-bold text-slate-900">
                                                {Object.values(analysis).reduce((a,b) => a + b.totalQuantity, 0)}
                                            </span>
                                            <span className="text-slate-400 text-sm mb-1">Pezzi tot.</span>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <p className="text-sm font-medium text-slate-500 mb-1">Fatture Archiviate</p>
                                        <div className="flex items-end gap-2">
                                            <span className="text-3xl font-bold text-slate-900">{invoices.length}</span>
                                            <span className="text-indigo-500 text-sm font-bold mb-1">Record</span>
                                        </div>
                                    </div>
                                </div>

                                {/* TABELLA PRINCIPALE */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-6 border-b border-slate-50 flex items-center justify-between">
                                        <h3 className="font-bold text-slate-800">Analisi Margini per Prodotto</h3>
                                        <input 
                                            type="text" 
                                            placeholder="Cerca prodotto..." 
                                            className="px-4 py-2 bg-slate-50 border-none rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500 w-64"
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                                                <tr>
                                                    <th className="px-6 py-4">Prodotto</th>
                                                    <th className="px-6 py-4">Costo Reale</th>
                                                    <th className="px-6 py-4">Prezzo Online</th>
                                                    <th className="px-6 py-4">Margine</th>
                                                    <th className="px-6 py-4 text-center">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filteredAnalysis.map(([name, data]) => (
                                                    <tr key={name} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-6 py-4 font-semibold text-slate-700">{name}</td>
                                                        <td className="px-6 py-4 text-slate-600">â‚¬ {data.avgRealCost.toFixed(2)}</td>
                                                        <td className="px-6 py-4 text-slate-600 font-medium">â‚¬ {data.onlinePrice.toFixed(2)}</td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-3">
                                                                <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden min-w-[60px]">
                                                                    <div 
                                                                        className={`h-full rounded-full ${data.margin > 30 ? 'bg-green-500' : data.margin > 15 ? 'bg-amber-500' : 'bg-red-500'}`}
                                                                        style={{width: `${Math.min(100, Math.max(0, data.margin))}%`}}
                                                                    ></div>
                                                                </div>
                                                                <span className="font-bold text-slate-800">{data.margin.toFixed(1)}%</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-center">
                                                            <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase ${data.margin > 30 ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                                                                {data.margin > 30 ? 'Ottimo' : 'Revisionare'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ... Altre Tab (Invoices, Credits, Prices) avranno la stessa estetica pulita ... */}
                        {activeTab !== 'dashboard' && (
                            <div className="bg-white p-12 rounded-3xl border-2 border-dashed border-slate-200 text-center">
                                <p className="text-slate-400 font-medium italic">Sezione {activeTab} in fase di caricamento stilistico...</p>
                                <p className="text-xs text-slate-300 mt-2">Usa la Dashboard per visualizzare i dati attuali.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
