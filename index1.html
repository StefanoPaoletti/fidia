<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidia Analytics Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .sidebar-active { border-right: 4px solid #4f46e5; background: linear-gradient(90deg, rgba(79, 70, 229, 0.08) 0%, rgba(255, 255, 255, 0) 100%); color: #4f46e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxv9Xxi4i-Kw0pPK8Xd7YYFpqr992YCoTd7mZog77PYDlXosRMnY_3sQ6hZOC5pBgVq/exec';
        
        const PRODUCTS = [
            'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
            'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
            'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
            'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
            'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ].sort();

        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];

        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" /></svg>,
            Invoice: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            Credit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12z" /></svg>,
            Price: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        };

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
            
            const [invoices, setInvoices] = useState([]);
            const [creditNotes, setCreditNotes] = useState([]);
            const [onlinePrices, setOnlinePrices] = useState({});
            const priceTimerRef = useRef(null);

            useEffect(() => {
                const pass = localStorage.getItem('fidiaAppPassword');
                if (pass) { setIsAuthenticated(true); loadData(); }
            }, []);

            const loadData = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(SCRIPT_URL);
                    const data = await response.json();
                    
                    const invoiceMap = {};
                    (data.invoices || []).forEach(row => {
                        if (!invoiceMap[row.id]) {
                            invoiceMap[row.id] = { ...row, items: [] };
                        }
                        invoiceMap[row.id].items.push(row);
                    });
                    
                    setInvoices(Object.values(invoiceMap));
                    setCreditNotes(data.creditNotes || []);
                    setOnlinePrices(data.onlinePrices || {});
                } catch (e) { alert("Errore connessione"); }
                setIsLoading(false);
            };

            const analysis = useMemo(() => {
                const result = {};
                const filteredInvoices = selectedYear === 'all' ? invoices : invoices.filter(inv => String(inv.year) === selectedYear);
                
                // Pre-calcolo totale costi anno per ripartizione note credito
                const totalCostByYear = {};
                filteredInvoices.forEach(inv => {
                    const year = String(inv.year);
                    if (!totalCostByYear[year]) totalCostByYear[year] = 0;
                    inv.items.forEach(item => {
                        const q = parseFloat(item.quantity) || 0;
                        const net = parseFloat(item.priceNet || item.priceGross) || 0;
                        const vat = parseFloat(item.vat) || 10;
                        totalCostByYear[year] += (q * net * (1 + vat/100));
                    });
                });

                PRODUCTS.forEach(product => {
                    let totalCost = 0;
                    let totalQty = 0;
                    let yearCostMap = {};

                    filteredInvoices.forEach(inv => {
                        const totalPieces = inv.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                        const shipping = parseFloat(inv.shippingCost) || 0;

                        inv.items.forEach(item => {
                            if (item.product !== product) return;
                            const q = parseFloat(item.quantity) || 0;
                            const f = parseFloat(item.freebies) || 0;
                            const net = parseFloat(item.priceNet || item.priceGross) || 0;
                            const vat = parseFloat(item.vat) || 10;
                            
                            const itemNetCost = q * net * (1 + vat/100);
                            const shippingShare = totalPieces > 0 ? ((q + f) / totalPieces) * shipping * 1.22 : 0;
                            
                            totalCost += (itemNetCost + shippingShare);
                            totalQty += (q + f);
                            
                            if (!yearCostMap[inv.year]) yearCostMap[inv.year] = 0;
                            yearCostMap[inv.year] += (itemNetCost + shippingShare);
                        });
                    });

                    // Sottrazione note credito proporzionali
                    const relevantCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(c => String(c.year) === selectedYear);
                    relevantCredits.forEach(c => {
                        const y = String(c.year);
                        if (yearCostMap[y] && totalCostByYear[y]) {
                            totalCost -= (c.amount * (yearCostMap[y] / totalCostByYear[y]));
                        }
                    });

                    const avg = totalQty > 0 ? totalCost / totalQty : 0;
                    const online = onlinePrices[product] || 0;
                    result[product] = {
                        avgCost: avg,
                        online: online,
                        margin: online > 0 ? ((online - avg) / online) * 100 : 0,
                        qty: totalQty
                    };
                });
                return result;
            }, [invoices, creditNotes, onlinePrices, selectedYear]);

            const stats = useMemo(() => {
                const active = Object.values(analysis).filter(d => d.qty > 0);
                const totalInvested = active.reduce((sum, d) => sum + (d.avgCost * d.qty), 0);
                const totalPotential = active.reduce((sum, d) => sum + (d.online * d.qty), 0);
                const avgMargin = totalPotential > 0 ? ((totalPotential - totalInvested) / totalPotential) * 100 : 0;
                return { totalInvested, totalPotential, avgMargin };
            }, [analysis]);

            if (!isAuthenticated) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6">
                    <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-10 animate-fade-in">
                        <div className="text-center mb-10">
                            <div className="inline-flex items-center justify-center w-20 h-20 bg-indigo-50 text-indigo-600 rounded-3xl mb-6">
                                <Icons.Dashboard />
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 tracking-tight">Fidia Analytics</h1>
                            <p className="text-slate-400 mt-2 font-medium">Inserisci la chiave di accesso</p>
                        </div>
                        <input 
                            type="password" 
                            className="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none mb-6 transition-all"
                            placeholder="Password"
                            onKeyDown={e => e.key === 'Enter' && (localStorage.setItem('fidiaAppPassword', e.target.value), setIsAuthenticated(true), loadData())}
                        />
                        <button 
                            onClick={() => { const p = document.querySelector('input').value; localStorage.setItem('fidiaAppPassword', p); setIsAuthenticated(true); loadData(); }}
                            className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100"
                        >
                            Accedi al Sistema
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex">
                    {/* SIDEBAR */}
                    <aside className="w-72 bg-white border-r border-slate-200 hidden lg:flex flex-col fixed h-full z-20">
                        <div className="p-8 border-b border-slate-50">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-indigo-600 rounded-lg"></div>
                                <h2 className="text-xl font-black text-slate-800 tracking-tighter">FIDIA <span className="text-indigo-600">PRO</span></h2>
                            </div>
                        </div>
                        
                        <nav className="flex-1 p-6 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Dashboard /> },
                                { id: 'invoices', label: 'Fatture', icon: <Icons.Invoice /> },
                                { id: 'credits', label: 'Note Credito', icon: <Icons.Credit /> },
                                { id: 'prices', label: 'Prezzi Online', icon: <Icons.Price /> },
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all ${activeTab === item.id ? 'sidebar-active shadow-sm' : 'text-slate-400 hover:bg-slate-50 hover:text-slate-600'}`}
                                >
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>

                        <div className="p-8 border-t border-slate-50">
                            <button onClick={() => {localStorage.clear(); location.reload();}} className="flex items-center gap-3 text-red-500 font-bold text-sm hover:bg-red-50 w-full p-4 rounded-xl transition-all">
                                ðŸ”Œ Disconnetti
                            </button>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 lg:ml-72 p-6 lg:p-12">
                        {isLoading && <div className="fixed top-0 left-0 w-full h-1 bg-indigo-600 animate-pulse z-50"></div>}
                        
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6 animate-fade-in">
                            <div>
                                <h1 className="text-3xl font-black text-slate-800 capitalize tracking-tight">{activeTab}</h1>
                                <p className="text-slate-500 font-medium">Gestione dati analitici Fidia Pharma</p>
                            </div>
                            <div className="flex items-center gap-3 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                                <select 
                                    value={selectedYear} 
                                    onChange={e => setSelectedYear(e.target.value)}
                                    className="bg-transparent border-none px-4 py-2 font-bold text-slate-700 outline-none"
                                >
                                    <option value="all">Storico Completo</option>
                                    {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                                <button onClick={loadData} className="p-2 hover:bg-slate-50 rounded-xl transition-all text-indigo-600">ðŸ”„</button>
                            </div>
                        </header>

                        {/* DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-10 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-2xl shadow-indigo-200">
                                        <p className="text-indigo-100 text-sm font-bold uppercase tracking-wider">Costo Reale Totale</p>
                                        <h3 className="text-4xl font-black mt-2">â‚¬ {stats.totalInvested.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 card-hover">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-wider">Incasso Potenziale</p>
                                        <h3 className="text-4xl font-black text-slate-800 mt-2">â‚¬ {stats.totalPotential.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 card-hover">
                                        <p className="text-slate-400 text-sm font-bold uppercase tracking-wider">Margine Medio</p>
                                        <div className="flex items-baseline gap-2 mt-2">
                                            <h3 className={`text-4xl font-black ${stats.avgMargin > 25 ? 'text-green-500' : 'text-amber-500'}`}>{stats.avgMargin.toFixed(1)}%</h3>
                                            <span className="text-slate-300 font-bold">ROI</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-8 border-b border-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <h4 className="text-xl font-black text-slate-800">Dettaglio Prodotti</h4>
                                        <div className="relative group">
                                            <Icons.Search />
                                            <input 
                                                type="text" 
                                                placeholder="Cerca un prodotto..." 
                                                className="pl-10 pr-6 py-3 bg-slate-50 border-none rounded-2xl text-sm w-full md:w-80 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                                onChange={e => setSearchTerm(e.target.value)}
                                            />
                                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto custom-scrollbar">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                                                    <th className="px-8 py-5">Prodotto</th>
                                                    <th className="px-8 py-5">QtÃ  Venduta</th>
                                                    <th className="px-8 py-5">Costo Reale</th>
                                                    <th className="px-8 py-5">Prezzo Online</th>
                                                    <th className="px-8 py-5">Margine</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {Object.entries(analysis)
                                                    .filter(([name, d]) => name.toLowerCase().includes(searchTerm.toLowerCase()) && d.qty > 0)
                                                    .sort((a,b) => b[1].qty - a[1].qty)
                                                    .map(([name, data]) => (
                                                    <tr key={name} className="group hover:bg-slate-50/50 transition-colors">
                                                        <td className="px-8 py-6">
                                                            <span className="font-bold text-slate-700 block">{name}</span>
                                                        </td>
                                                        <td className="px-8 py-6 text-slate-500 font-bold">{data.qty} <span className="text-[10px] opacity-50">PZ</span></td>
                                                        <td className="px-8 py-6 font-bold text-slate-900">â‚¬ {data.avgCost.toFixed(2)}</td>
                                                        <td className="px-8 py-6 font-bold text-indigo-600">â‚¬ {data.online.toFixed(2)}</td>
                                                        <td className="px-8 py-6">
                                                            <div className="flex items-center gap-4">
                                                                <div className="w-24 h-2 bg-slate-100 rounded-full overflow-hidden hidden sm:block">
                                                                    <div 
                                                                        className={`h-full rounded-full transition-all duration-1000 ${data.margin > 25 ? 'bg-green-500' : data.margin > 15 ? 'bg-amber-500' : 'bg-red-500'}`}
                                                                        style={{width: `${Math.max(0, Math.min(100, data.margin))}%`}}
                                                                    ></div>
                                                                </div>
                                                                <span className={`font-black text-sm ${data.margin > 25 ? 'text-green-500' : 'text-amber-500'}`}>{data.margin.toFixed(1)}%</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* PREZZI ONLINE */}
                        {activeTab === 'prices' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
                                {PRODUCTS.map(prod => (
                                    <div key={prod} className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm card-hover flex flex-col gap-4">
                                        <div className="flex justify-between items-start">
                                            <span className="text-[10px] font-black text-indigo-600 uppercase tracking-widest">Update Price</span>
                                            <span className="w-2 h-2 rounded-full bg-green-500"></span>
                                        </div>
                                        <label className="text-lg font-bold text-slate-800 truncate">{prod}</label>
                                        <div className="relative">
                                            <span className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-300 font-black text-xl">â‚¬</span>
                                            <input 
                                                type="number"
                                                value={onlinePrices[prod] || ''}
                                                onChange={e => {
                                                    const val = e.target.value;
                                                    setOnlinePrices(prev => ({...prev, [prod]: val}));
                                                    if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
                                                    priceTimerRef.current = setTimeout(() => {
                                                        fetch(SCRIPT_URL, {
                                                            method: 'POST',
                                                            mode: 'no-cors',
                                                            body: JSON.stringify({ action: 'saveOnlinePrice', product: prod, price: parseFloat(val) || 0, password: localStorage.getItem('fidiaAppPassword') })
                                                        });
                                                    }, 1500);
                                                }}
                                                placeholder="0.00"
                                                className="w-full pl-8 py-2 text-2xl font-black text-slate-800 outline-none border-b-2 border-slate-50 focus:border-indigo-500 transition-all"
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* PLACEHOLDER PER ALTRE TAB */}
                        {(activeTab === 'invoices' || activeTab === 'credits') && (
                            <div className="bg-white p-20 rounded-[3rem] border-2 border-dashed border-slate-100 text-center animate-fade-in">
                                <p className="text-slate-400 font-bold italic">Interfaccia di inserimento {activeTab} in arrivo...</p>
                                <p className="text-xs text-slate-300 mt-2 uppercase tracking-widest font-black">Usa la Dashboard per visualizzare l'analisi corrente</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
