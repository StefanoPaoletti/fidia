<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidia Analytics Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .sidebar-active { border-right: 4px solid #4f46e5; background: linear-gradient(90deg, rgba(79, 70, 229, 0.08) 0%, rgba(255, 255, 255, 0) 100%); color: #4f46e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Nuova URL fornita
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzWNF1IztITgiIVocJW7t09ijrmYQOz8R1RekoEstss8S-d8_8Ylopv8S-EZOprVD99/exec';
        
        const PRODUCTS = [
            'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'LACRISEK', 'LUTEINOMEGA', 'MERAMIRT', 
            'MERAMIRT CM', 'MERAMIRT XG', 'MYRIALEN GEL', 'OPTO CARE', 'OPTO GEL', 
            'OPTO IDRO', 'OPTO MYO', 'OPTO OMEGA', 'OPTO RED', 'OPTO RELAX', 
            'OPTO SOL', 'OPTO VITREO', 'OPTO YAL', 'OPTO YAL CREAM', 'PROLENS', 
            'RESPILENS 100', 'RESPILENS 360', 'TRIUM', 'VITREOXIGEN'
        ].sort();

        const YEARS = ['2023', '2024', '2025', '2026'];

        // Componenti Icone
        const Icons = {
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg>,
            Tag: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
            History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
            Save: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
        };

        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
            
            // Dati
            const [invoices, setInvoices] = useState([]);
            const [onlinePrices, setOnlinePrices] = useState({});
            const priceTimerRef = useRef(null);

            useEffect(() => {
                const pass = localStorage.getItem('fidia_auth');
                if (pass) { setIsAuthenticated(true); fetchData(); }
            }, []);

            const fetchData = async () => {
                setIsLoading(true);
                try {
                    const res = await fetch(SCRIPT_URL);
                    const data = await res.json();
                    setInvoices(data.invoices || []);
                    setOnlinePrices(data.onlinePrices || {});
                } catch (e) { console.error("Errore caricamento", e); }
                setIsLoading(false);
            };

            const analysis = useMemo(() => {
                const results = {};
                const filteredInvoices = selectedYear === 'Tutti' ? invoices : invoices.filter(inv => String(inv.year) === selectedYear);

                PRODUCTS.forEach(prod => {
                    const rows = filteredInvoices.filter(r => r.product === prod);
                    let totalQty = 0, totalNetCost = 0;

                    rows.forEach(r => {
                        const q = parseFloat(r.quantity) || 0;
                        const f = parseFloat(r.freebies) || 0;
                        const price = parseFloat(r.priceNet) || 0;
                        const vat = parseFloat(r.vat) || 10;
                        
                        totalQty += (q + f);
                        totalNetCost += (q * price * (1 + vat/100));
                    });

                    const avgCost = totalQty > 0 ? totalNetCost / totalQty : 0;
                    const online = onlinePrices[prod] || 0;
                    
                    results[prod] = {
                        avgCost,
                        online,
                        margin: online > 0 ? ((online - avgCost) / online) * 100 : 0,
                        qty: totalQty
                    };
                });
                return results;
            }, [invoices, onlinePrices, selectedYear]);

            const handlePriceChange = (prod, val) => {
                const newPrices = { ...onlinePrices, [prod]: parseFloat(val) || 0 };
                setOnlinePrices(newPrices);

                if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
                priceTimerRef.current = setTimeout(async () => {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ type: 'UPDATE_PRICES', prices: newPrices })
                    });
                }, 1500);
            };

            if (!isAuthenticated) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
                        <h2 className="text-2xl font-bold text-center mb-6">Fidia Analytics Login</h2>
                        <input 
                            type="password" 
                            placeholder="Password" 
                            className="w-full p-4 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500"
                            onKeyDown={e => e.key === 'Enter' && (localStorage.setItem('fidia_auth', 'ok'), setIsAuthenticated(true), fetchData())}
                        />
                        <button 
                            onClick={() => { localStorage.setItem('fidia_auth', 'ok'); setIsAuthenticated(true); fetchData(); }}
                            className="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold hover:bg-indigo-700 transition-all"
                        >
                            Entra nell'area Pro
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex bg-slate-50">
                    {/* SIDEBAR */}
                    <aside className="w-72 bg-white border-r border-slate-200 hidden lg:flex flex-col sticky top-0 h-screen">
                        <div className="p-8 border-b border-slate-100">
                            <h1 className="text-2xl font-black text-indigo-600 tracking-tighter">FIDIA ANALYTICS</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Management Tool v2.0</p>
                        </div>
                        
                        <nav className="flex-1 p-4 space-y-2 mt-4">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Chart /> },
                                { id: 'prices', label: 'Prezzi Online', icon: <Icons.Tag /> },
                                { id: 'history', label: 'Storico Fatture', icon: <Icons.History /> },
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all ${activeTab === item.id ? 'sidebar-active shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}
                                >
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>

                        <div className="p-6 border-t border-slate-100">
                            <button onClick={() => {localStorage.clear(); location.reload();}} className="flex items-center gap-2 text-red-500 font-bold text-sm hover:opacity-70">
                                <span>Logout</span>
                            </button>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 p-6 lg:p-12 max-w-7xl mx-auto w-full">
                        {isLoading && <div className="fixed top-0 left-0 w-full h-1 bg-indigo-600 animate-pulse z-50"></div>}
                        
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                            <div>
                                <h2 className="text-3xl font-extrabold text-slate-800 capitalize">{activeTab}</h2>
                                <p className="text-slate-500 mt-1">Dati aggiornati in tempo reale dal backend Google.</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <select 
                                    value={selectedYear} 
                                    onChange={e => setSelectedYear(e.target.value)}
                                    className="bg-white border-slate-200 border px-4 py-2 rounded-xl font-bold text-sm shadow-sm outline-none"
                                >
                                    {['Tutti', ...YEARS].map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                                <button onClick={fetchData} className="p-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm">ðŸ”„</button>
                            </div>
                        </div>

                        {/* DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-in fade-in duration-500">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-indigo-600 p-8 rounded-[2rem] text-white shadow-xl shadow-indigo-100">
                                        <p className="opacity-80 text-sm font-medium">Fatture Totali</p>
                                        <h3 className="text-4xl font-black mt-1">{invoices.length}</h3>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm card-hover">
                                        <p className="text-slate-500 text-sm font-medium">Prodotti in Catalogo</p>
                                        <h3 className="text-4xl font-black text-slate-800 mt-1">{PRODUCTS.length}</h3>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm card-hover">
                                        <p className="text-slate-500 text-sm font-medium">Anno Corrente</p>
                                        <h3 className="text-4xl font-black text-indigo-600 mt-1">{new Date().getFullYear()}</h3>
                                    </div>
                                </div>

                                <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-8 border-b border-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <h4 className="text-xl font-black text-slate-800">Analisi RedditivitÃ </h4>
                                        <div className="relative">
                                            <input 
                                                type="text" 
                                                placeholder="Cerca prodotto..." 
                                                className="pl-10 pr-4 py-2 bg-slate-50 border-none rounded-xl text-sm w-full md:w-64 focus:ring-2 focus:ring-indigo-500 outline-none"
                                                onChange={e => setSearchTerm(e.target.value)}
                                            />
                                            <svg className="w-4 h-4 absolute left-3 top-2.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto custom-scrollbar">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                                                    <th className="px-8 py-4">Prodotto</th>
                                                    <th className="px-8 py-4">Pezzi</th>
                                                    <th className="px-8 py-4">Costo Reale (IVA Incl.)</th>
                                                    <th className="px-8 py-4">Prezzo Online</th>
                                                    <th className="px-8 py-4">Margine %</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {Object.entries(analysis)
                                                    .filter(([name]) => name.toLowerCase().includes(searchTerm.toLowerCase()))
                                                    .map(([name, data]) => (
                                                    <tr key={name} className="group hover:bg-slate-50/50 transition-colors">
                                                        <td className="px-8 py-5 font-bold text-slate-700">{name}</td>
                                                        <td className="px-8 py-5 text-slate-500 font-medium">{data.qty}</td>
                                                        <td className="px-8 py-5 font-semibold text-slate-900">â‚¬ {data.avgCost.toFixed(2)}</td>
                                                        <td className="px-8 py-5 font-semibold text-indigo-600">â‚¬ {data.online.toFixed(2)}</td>
                                                        <td className="px-8 py-5">
                                                            <div className="flex items-center gap-3">
                                                                <span className={`text-sm font-black ${data.margin > 25 ? 'text-green-500' : data.margin > 10 ? 'text-amber-500' : 'text-red-500'}`}>
                                                                    {data.margin.toFixed(1)}%
                                                                </span>
                                                                <div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                                    <div 
                                                                        className={`h-full rounded-full ${data.margin > 25 ? 'bg-green-500' : data.margin > 10 ? 'bg-amber-500' : 'bg-red-500'}`}
                                                                        style={{width: `${Math.max(0, Math.min(100, data.margin))}%`}}
                                                                    ></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* PREZZI ONLINE */}
                        {activeTab === 'prices' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 animate-in slide-in-from-bottom-4 duration-500">
                                {PRODUCTS.map(prod => (
                                    <div key={prod} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-2">
                                        <label className="text-xs font-black text-slate-400 uppercase">{prod}</label>
                                        <div className="flex items-center gap-2">
                                            <span className="text-slate-400 font-bold">â‚¬</span>
                                            <input 
                                                type="number"
                                                value={onlinePrices[prod] || ''}
                                                onChange={e => handlePriceChange(prod, e.target.value)}
                                                placeholder="0.00"
                                                className="w-full text-lg font-bold outline-none border-b-2 border-transparent focus:border-indigo-500 transition-colors"
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* STORICO (Placeholder elegante) */}
                        {activeTab === 'history' && (
                            <div className="bg-white rounded-[2.5rem] p-12 text-center border border-dashed border-slate-200">
                                <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icons.History />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800">Storico Documenti</h3>
                                <p className="text-slate-500 mt-2 max-w-sm mx-auto">Qui potrai visualizzare l'elenco completo delle fatture e delle note di credito archiviate nel database.</p>
                                <button onClick={() => setActiveTab('dashboard')} className="mt-8 text-indigo-600 font-bold hover:underline">Torna alla Dashboard</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
