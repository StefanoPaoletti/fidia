<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Prezzi Fidia</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ];

        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];

        const SHEET_ID = '1FvExAXdbcPeA3vowfpVm1D4IO68GYF4s5GpzesvAJu8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwuEWozOVeAr4PGqHubuWuxqE7cQkPPuecb_nwobD4jphIU7yzHtxsyb5u5b-wjTOu/exec';

        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState('all');
          const [isLoading, setIsLoading] = useState(false);

          const [invoiceDate, setInvoiceDate] = useState('');
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [invoiceYear, setInvoiceYear] = useState('2025');
          const [shippingCost, setShippingCost] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([
            { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }
          ]);

          const [creditYear, setCreditYear] = useState('2025');
          const [creditAmount, setCreditAmount] = useState('');
          
          const [editingInvoice, setEditingInvoice] = useState(null);

          useEffect(() => {
            if (isAuthenticated) {
              loadFromGoogleSheets();
            }
          }, [isAuthenticated]);

          const loadFromGoogleSheets = async () => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              const data = await response.json();
              
              const invoiceMap = {};
              data.invoices.forEach(row => {
                if (!invoiceMap[row.id]) {
                  invoiceMap[row.id] = {
                    id: row.id,
                    year: row.year,
                    date: row.date,
                    number: row.number,
                    shippingCost: row.shippingCost || 0,
                    items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product,
                  quantity: row.quantity,
                  price: row.priceGross, // Uso il prezzo LORDO per la modifica
                  discount: row.discount || 0,
                  vat: row.vat,
                  freebies: row.freebies,
                  priceNet: row.priceNet, // Tengo anche il netto per i calcoli
                  shippingCost: row.shippingCost || 0
                });
              });
              
              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes);
              setOnlinePrices(data.onlinePrices);
            } catch (error) {
              console.error('Errore nel caricamento:', error);
              alert('Errore nel caricamento dei dati da Google Sheets');
            }
            setIsLoading(false);
          };

          const saveToGoogleSheets = async (action, data) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...data }),
                mode: 'no-cors'
              });
              
              setTimeout(async () => {
                await loadFromGoogleSheets();
              }, 1000);
              
              return true;
            } catch (error) {
              console.error('Errore nel salvataggio:', error);
              alert('Errore nel salvataggio su Google Sheets: ' + error.message);
              setIsLoading(false);
              return false;
            }
          };

          const handleLogin = () => {
            if (password === 'Fidia2026%') {
              setIsAuthenticated(true);
            } else {
              alert('Password errata!');
            }
          };

          const addInvoiceItem = () => {
            setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', vat: '10', freebies: '' }]);
          };

          const removeInvoiceItem = (index) => {
            setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
          };

          const updateInvoiceItem = (index, field, value) => {
            const updated = [...invoiceItems];
            updated[index][field] = value;
            setInvoiceItems(updated);
          };

          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(item => 
              item.product && 
              item.quantity && 
              !isNaN(parseFloat(item.quantity)) &&
              item.price && 
              !isNaN(parseFloat(item.price))
            );
            
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) {
              alert('Compila tutti i campi obbligatori! Assicurati che quantit√† e prezzo siano numeri validi.');
              return;
            }

            const shipping = parseFloat(shippingCost) || 0;

            const newInvoice = {
              id: Date.now(),
              date: invoiceDate,
              number: invoiceNumber,
              year: invoiceYear,
              shippingCost: shipping,
              items: validItems.map(item => {
                const grossPrice = parseFloat(item.price);
                const discount = parseFloat(item.discount) || 0;
                const netPrice = grossPrice * (1 - discount / 100);
                
                return {
                  product: item.product,
                  quantity: parseFloat(item.quantity),
                  priceGross: grossPrice,    // Prezzo LORDO (prima dello sconto)
                  priceNet: netPrice,        // Prezzo NETTO (dopo sconto)
                  discount: discount,
                  vat: item.vat || '10',
                  freebies: parseFloat(item.freebies) || 0
                };
              })
            };

            const success = await saveToGoogleSheets('saveInvoice', newInvoice);
            
            if (success) {
              setInvoiceDate('');
              setInvoiceNumber('');
              setShippingCost('');
              setInvoiceItems([{ product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
              alert('Fattura salvata su Google Sheets!');
            }
          };

          const saveCreditNote = async () => {
            if (!creditAmount) {
              alert('Inserisci l\'importo!');
              return;
            }

            const newNote = {
              id: Date.now(),
              year: creditYear,
              amount: parseFloat(creditAmount)
            };

            const success = await saveToGoogleSheets('saveCreditNote', newNote);
            
            if (success) {
              setCreditAmount('');
              alert('Nota di credito salvata su Google Sheets!');
            }
          };

          const deleteInvoice = async (id) => {
            if (confirm('Sei sicuro di voler eliminare questa fattura?')) {
              await saveToGoogleSheets('deleteInvoice', { id });
            }
          };
          
          const startEditInvoice = (invoice) => {
            setEditingInvoice(invoice);
            setInvoiceYear(invoice.year);
            setInvoiceDate(invoice.date);
            setInvoiceNumber(invoice.number);
            setShippingCost(invoice.shippingCost || '');
            setInvoiceItems(invoice.items.map(item => ({
              product: item.product || '',
              quantity: item.quantity || '',
              price: item.price || '',
              discount: item.discount || '',
              vat: item.vat || '10',
              freebies: item.freebies || ''
            })));
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          const cancelEdit = () => {
            setEditingInvoice(null);
            setInvoiceDate('');
            setInvoiceNumber('');
            setInvoiceYear('2025');
            setShippingCost('');
            setInvoiceItems([{ product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          };
          
          const updateInvoice = async () => {
            const validItems = invoiceItems.filter(item => 
              item.product && 
              item.quantity && 
              !isNaN(parseFloat(item.quantity)) &&
              item.price && 
              !isNaN(parseFloat(item.price))
            );
            
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) {
              alert('Compila tutti i campi obbligatori! Assicurati che quantit√† e prezzo siano numeri validi.');
              return;
            }
            
            const shipping = parseFloat(shippingCost) || 0;
            
            // Prima elimina la vecchia fattura
            await saveToGoogleSheets('deleteInvoice', { id: editingInvoice.id });
            
            // Poi salva quella nuova con lo stesso ID
            const updatedInvoice = {
              id: editingInvoice.id,
              date: invoiceDate,
              number: invoiceNumber,
              year: invoiceYear,
              shippingCost: shipping,
              items: validItems.map(item => {
                const grossPrice = parseFloat(item.price);
                const discount = parseFloat(item.discount) || 0;
                const netPrice = grossPrice * (1 - discount / 100);
                
                return {
                  product: item.product,
                  quantity: parseFloat(item.quantity),
                  priceGross: grossPrice,    // Prezzo LORDO (prima dello sconto)
                  priceNet: netPrice,        // Prezzo NETTO (dopo sconto)
                  discount: discount,
                  vat: item.vat || '10',
                  freebies: parseFloat(item.freebies) || 0
                };
              })
            };
            
            const success = await saveToGoogleSheets('saveInvoice', updatedInvoice);
            
            if (success) {
              cancelEdit();
              alert('Fattura aggiornata!');
            }
          };

          const deleteCreditNote = async (id) => {
            if (confirm('Sei sicuro di voler eliminare questa nota di credito?')) {
              await saveToGoogleSheets('deleteCreditNote', { id });
            }
          };

          const updateOnlinePrice = async (product, price) => {
            if (price && !isNaN(price)) {
              await saveToGoogleSheets('saveOnlinePrice', { product, price: parseFloat(price) });
            }
          };
          
          const exportDashboardImage = async () => {
            const dashboardElement = document.getElementById('dashboard-table');
            if (!dashboardElement) {
              alert('Errore: tabella non trovata');
              return;
            }
            
            try {
              const canvas = await html2canvas(dashboardElement, {
                backgroundColor: '#ffffff',
                scale: 2, // Alta qualit√†
                logging: false
              });
              
              const link = document.createElement('a');
              link.download = `analisi-margini-${selectedYear}-${new Date().toISOString().split('T')[0]}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            } catch (error) {
              console.error('Errore nell\'esportazione:', error);
              alert('Errore nell\'esportazione dell\'immagine');
            }
          };

          const calculateProductAnalysis = (filterYear = null) => {
            const analysis = {};

            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQuantity = 0;
              let yearCost = {};
              let yearQuantity = {};

              // Filtra le fatture per anno se specificato
              const filteredInvoices = filterYear && filterYear !== 'all' 
                ? invoices.filter(inv => String(inv.year) === String(filterYear))
                : invoices;

              filteredInvoices.forEach(invoice => {
                // Calcola il numero TOTALE di pezzi nella fattura (per ripartire le spese di spedizione)
                const totalInvoicePieces = invoice.items.reduce((sum, item) => {
                  const qty = parseFloat(item.quantity) || 0;
                  const freebies = parseFloat(item.freebies) || 0;
                  return sum + qty + freebies;
                }, 0);
                const shippingCost = parseFloat(invoice.shippingCost) || 0;
                
                invoice.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const freebies = parseFloat(item.freebies) || 0;
                    const netPrice = parseFloat(item.priceNet || item.price) || 0; // Uso priceNet se esiste, altrimenti price (per fatture vecchie)
                    const vat = parseFloat(item.vat) || 0;
                    const totalQty = qty + freebies;
                    
                    // Calcola la quota di spese di spedizione per questo prodotto
                    // Ripartizione in base al numero di pezzi (semplice ed equa)
                    const shippingShare = totalInvoicePieces > 0 ? (totalQty / totalInvoicePieces) * shippingCost : 0;
                    
                    // Calcolo costo CORRETTO:
                    // 1. Prezzo netto con IVA del prodotto
                    const priceWithVAT = (qty * netPrice) * (1 + vat / 100);
                    
                    // 2. Quota spedizione con IVA 22% (SEMPRE)
                    const shippingWithVAT = shippingShare * 1.22;
                    
                    // 3. Costo totale
                    const totalItemCost = priceWithVAT + shippingWithVAT;
                    
                    totalCost += totalItemCost;
                    totalQuantity += totalQty;

                    if (!yearCost[invoice.year]) {
                      yearCost[invoice.year] = 0;
                      yearQuantity[invoice.year] = 0;
                    }
                    yearCost[invoice.year] += totalItemCost;
                    yearQuantity[invoice.year] += totalQty;
                  }
                });
              });

              Object.keys(yearCost).forEach(year => {
                // Applica note di credito solo degli anni considerati
                const relevantCreditNotes = filterYear && filterYear !== 'all'
                  ? creditNotes.filter(cn => cn.year === filterYear)
                  : creditNotes;
                
                const yearCredit = relevantCreditNotes
                  .filter(cn => cn.year === year)
                  .reduce((sum, cn) => sum + cn.amount, 0);

                // FIX: calcola yearTotal solo sugli anni effettivamente considerati
                const yearTotal = filterYear && filterYear !== 'all' 
                  ? yearCost[year]  // solo l'anno filtrato
                  : Object.values(yearCost).reduce((sum, cost) => sum + cost, 0);  // tutti gli anni
                
                if (yearTotal > 0) {
                  const proportion = yearCost[year] / yearTotal;
                  yearCost[year] -= yearCredit * proportion;
                }
              });

              const totalCostWithCredits = Object.values(yearCost).reduce((sum, cost) => sum + cost, 0);
              const avgRealCost = totalQuantity > 0 ? totalCostWithCredits / totalQuantity : 0;
              const onlinePrice = onlinePrices[product] || 0;
              const margin = onlinePrice > 0 ? ((onlinePrice - avgRealCost) / onlinePrice * 100) : 0;

              analysis[product] = {
                avgRealCost,
                onlinePrice,
                margin,
                totalQuantity,
                yearData: Object.keys(yearCost).map(year => ({
                  year,
                  cost: yearQuantity[year] > 0 ? yearCost[year] / yearQuantity[year] : 0,
                  quantity: yearQuantity[year]
                }))
              };
            });

            return analysis;
          };

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Analisi Prezzi Fidia</h1>
                  <div className="space-y-4">
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        placeholder="Inserisci password"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <button
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                      >
                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                      </button>
                    </div>
                    <button
                      onClick={handleLogin}
                      className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                    >
                      Accedi
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          const analysis = calculateProductAnalysis(selectedYear);
          
          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed top-0 left-0 right-0 bg-blue-600 text-white py-2 text-center z-50">
                  üîÑ Sincronizzazione con Google Sheets...
                </div>
              )}
              
              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-gray-800">Analisi Prezzi Fidia</h1>
                    <div className="flex gap-2 items-center">
                      <span className="text-sm text-gray-600">üíæ Salvato su Google Sheets</span>
                      <button 
                        onClick={loadFromGoogleSheets} 
                        className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                        disabled={isLoading}
                      >
                        üîÑ Ricarica
                      </button>
                      <a 
                        href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`}
                        target="_blank"
                        className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                      >
                        üìä Apri Google Sheets
                      </a>
                      <a 
                        href="https://app.netlify.com/"
                        target="_blank"
                        className="px-3 py-2 bg-teal-600 text-white rounded hover:bg-teal-700"
                      >
                        üöÄ Netlify
                      </a>
                    </div>
                  </div>
                  <div className="flex gap-4 mt-4">
                    <button
                      onClick={() => setActiveTab('dashboard')}
                      className={`px-4 py-2 rounded ${activeTab === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Dashboard
                    </button>
                    <button
                      onClick={() => setActiveTab('invoices')}
                      className={`px-4 py-2 rounded ${activeTab === 'invoices' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Fatture
                    </button>
                    <button
                      onClick={() => setActiveTab('credits')}
                      className={`px-4 py-2 rounded ${activeTab === 'credits' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Note Credito
                    </button>
                    <button
                      onClick={() => setActiveTab('prices')}
                      className={`px-4 py-2 rounded ${activeTab === 'prices' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Prezzi Online
                    </button>
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-6">
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Analisi Margini</h2>
                        <div className="flex gap-2 items-center">
                          <select
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(e.target.value)}
                            className="px-4 py-2 border rounded"
                          >
                            <option value="all">Tutti gli anni</option>
                            {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                          </select>
                          <button
                            onClick={exportDashboardImage}
                            className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
                          >
                            üì∏ Esporta Immagine
                          </button>
                        </div>
                      </div>
                      <div id="dashboard-table" className="overflow-x-auto">
                        <table className="w-full">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="px-4 py-2 text-left">Prodotto</th>
                              <th className="px-4 py-2 text-right">Costo Reale ‚Ç¨</th>
                              <th className="px-4 py-2 text-right">Prezzo Online ‚Ç¨</th>
                              <th className="px-4 py-2 text-right">Margine %</th>
                              <th className="px-4 py-2 text-right">Qt√† Totale</th>
                              <th className="px-4 py-2 text-center">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {Object.entries(analysis)
                              .filter(([product, data]) => data.totalQuantity > 0) // Mostra solo prodotti con quantit√† > 0
                              .sort(([, a], [, b]) => a.margin - b.margin)
                              .map(([product, data]) => (
                                <tr key={product} className="border-b hover:bg-gray-50">
                                  <td className="px-4 py-3 font-medium">{product}</td>
                                  <td className="px-4 py-3 text-right">{data.avgRealCost.toFixed(2)}</td>
                                  <td className="px-4 py-3 text-right">{data.onlinePrice.toFixed(2)}</td>
                                  <td className={`px-4 py-3 text-right font-bold ${data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                    {data.margin.toFixed(1)}%
                                  </td>
                                  <td className="px-4 py-3 text-right">{data.totalQuantity}</td>
                                  <td className="px-4 py-3 text-center">
                                    {data.margin < 20 ? (
                                      <span className="text-red-600">‚ö†Ô∏è Basso</span>
                                    ) : data.margin < 30 ? (
                                      <span className="text-yellow-600">üìä Medio</span>
                                    ) : (
                                      <span className="text-green-600">‚úÖ Buono</span>
                                    )}
                                  </td>
                                </tr>
                              ))}
                            {(() => {
                              // Calcolo totali
                              const productsWithQty = Object.entries(analysis).filter(([, data]) => data.totalQuantity > 0);
                              const totalRevenue = productsWithQty.reduce((sum, [, data]) => 
                                sum + (data.onlinePrice * data.totalQuantity), 0
                              );
                              const totalCost = productsWithQty.reduce((sum, [, data]) => 
                                sum + (data.avgRealCost * data.totalQuantity), 0
                              );
                              const weightedMargin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue * 100) : 0;
                              
                              return (
                                <>
                                  <tr className="border-t-2 border-gray-400 bg-gray-50 font-bold">
                                    <td className="px-4 py-3" colSpan="6"></td>
                                  </tr>
                                  <tr className="bg-blue-50 font-semibold">
                                    <td className="px-4 py-3">üìä FATTURATO TOTALE STIMATO</td>
                                    <td className="px-4 py-3 text-right" colSpan="2">‚Ç¨ {totalRevenue.toFixed(2)}</td>
                                    <td className="px-4 py-3" colSpan="3"></td>
                                  </tr>
                                  <tr className="bg-orange-50 font-semibold">
                                    <td className="px-4 py-3">üí∞ COSTO TOTALE REALE</td>
                                    <td className="px-4 py-3 text-right" colSpan="2">‚Ç¨ {totalCost.toFixed(2)}</td>
                                    <td className="px-4 py-3" colSpan="3"></td>
                                  </tr>
                                  <tr className={`font-bold text-lg ${weightedMargin < 20 ? 'bg-red-100' : weightedMargin < 30 ? 'bg-yellow-100' : 'bg-green-100'}`}>
                                    <td className="px-4 py-3">üìà MARGINE MEDIO PONDERATO</td>
                                    <td className="px-4 py-3 text-right" colSpan="2"></td>
                                    <td className={`px-4 py-3 text-right ${weightedMargin < 20 ? 'text-red-600' : weightedMargin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                      {weightedMargin.toFixed(1)}%
                                    </td>
                                    <td className="px-4 py-3" colSpan="2"></td>
                                    <td className="px-4 py-3 text-center text-2xl">
                                      {weightedMargin < 20 ? '‚ùå' : weightedMargin < 30 ? '‚ö†Ô∏è' : '‚úÖ'}
                                    </td>
                                  </tr>
                                </>
                              );
                            })()}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'invoices' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">
                        {editingInvoice ? '‚úèÔ∏è Modifica Fattura' : 'Nuova Fattura'}
                      </h2>
                      <div className="grid grid-cols-4 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={invoiceYear} onChange={(e) => setInvoiceYear(e.target.value)} className="w-full px-3 py-2 border rounded">
                            {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Data Fattura</label>
                          <input type="date" value={invoiceDate} onChange={(e) => setInvoiceDate(e.target.value)} className="w-full px-3 py-2 border rounded" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={invoiceNumber} onChange={(e) => setInvoiceNumber(e.target.value)} placeholder="es. 3060003884" className="w-full px-3 py-2 border rounded" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Spese Spedizione ‚Ç¨</label>
                          <input type="number" step="0.01" value={shippingCost} onChange={(e) => setShippingCost(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 border rounded" />
                        </div>
                      </div>
                      
                      {shippingCost && parseFloat(shippingCost) > 0 && (
                        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
                          ‚ÑπÔ∏è Le spese di spedizione (‚Ç¨{parseFloat(shippingCost).toFixed(2)}) verranno divise equamente per il numero totale di pezzi della fattura (con IVA 22%).
                        </div>
                      )}

                      <div className="overflow-x-auto">
                        <table className="w-full mb-4">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="px-2 py-2 text-left">Quantit√†</th>
                              <th className="px-2 py-2 text-left">Prodotto</th>
                              <th className="px-2 py-2 text-left">Prezzo Unit. ‚Ç¨</th>
                              <th className="px-2 py-2 text-left">Sconto %</th>
                              <th className="px-2 py-2 text-left">IVA %</th>
                              <th className="px-2 py-2 text-left">Omaggi</th>
                              <th className="px-2 py-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {invoiceItems.map((item, index) => (
                              <tr key={index} className="border-b">
                                <td className="px-2 py-2">
                                  <input type="number" value={item.quantity} onChange={(e) => updateInvoiceItem(index, 'quantity', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" />
                                </td>
                                <td className="px-2 py-2">
                                  <select value={item.product} onChange={(e) => updateInvoiceItem(index, 'product', e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                    <option value="">Seleziona...</option>
                                    {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                                  </select>
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" step="0.01" value={item.price} onChange={(e) => updateInvoiceItem(index, 'price', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="Prezzo lordo" />
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" step="0.01" value={item.discount} onChange={(e) => updateInvoiceItem(index, 'discount', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" placeholder="0" />
                                </td>
                                <td className="px-2 py-2">
                                  <select value={item.vat} onChange={(e) => updateInvoiceItem(index, 'vat', e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                    <option value="10">10%</option>
                                    <option value="22">22%</option>
                                  </select>
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" value={item.freebies} onChange={(e) => updateInvoiceItem(index, 'freebies', e.target.value)} placeholder="0" className="w-full px-2 py-1 border rounded text-sm" />
                                </td>
                                <td className="px-2 py-2">
                                  <button onClick={() => removeInvoiceItem(index)} className="text-red-600 hover:text-red-800">
                                    üóëÔ∏è
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="flex gap-2">
                        <button onClick={addInvoiceItem} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                          ‚ûï Aggiungi Riga
                        </button>
                        {editingInvoice ? (
                          <>
                            <button onClick={updateInvoice} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" disabled={isLoading}>
                              ‚úÖ Aggiorna Fattura
                            </button>
                            <button onClick={cancelEdit} className="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500" disabled={isLoading}>
                              ‚ùå Annulla
                            </button>
                          </>
                        ) : (
                          <button onClick={saveInvoice} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled={isLoading}>
                            üíæ Salva Fattura
                          </button>
                        )}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Fatture Inserite ({invoices.length})</h2>
                      <div className="space-y-2">
                        {invoices.map(invoice => (
                          <div key={invoice.id} className="border rounded p-4 hover:bg-gray-50">
                            <div className="flex justify-between items-start">
                              <div>
                                <div className="font-bold">{invoice.number} - {invoice.date} ({invoice.year})</div>
                                <div className="text-sm text-gray-600 mt-1">
                                  {invoice.items.map((item, i) => (
                                    <div key={i}>
                                      {item.product}: {item.quantity} pz + {item.freebies || 0} omaggio @ ‚Ç¨{item.price}
                                    </div>
                                  ))}
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => startEditInvoice(invoice)} className="text-blue-600 hover:text-blue-800" disabled={isLoading}>
                                  ‚úèÔ∏è
                                </button>
                                <button onClick={() => deleteInvoice(invoice.id)} className="text-red-600 hover:text-red-800" disabled={isLoading}>
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'credits' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Nuova Nota di Credito</h2>
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={creditYear} onChange={(e) => setCreditYear(e.target.value)} className="w-full px-3 py-2 border rounded">
                            {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Importo Bonifico ‚Ç¨</label>
                          <input type="number" step="0.01" value={creditAmount} onChange={(e) => setCreditAmount(e.target.value)} placeholder="es. 500.00" className="w-full px-3 py-2 border rounded" />
                        </div>
                      </div>
                      <button onClick={saveCreditNote} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled={isLoading}>
                        üíæ Salva
                      </button>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Note di Credito ({creditNotes.length})</h2>
                      <div className="space-y-2">
                        {creditNotes.map(note => (
                          <div key={note.id} className="border rounded p-4 hover:bg-gray-50 flex justify-between items-center">
                            <div>
                              <span className="font-bold">{note.year}</span> - ‚Ç¨{note.amount.toFixed(2)}
                            </div>
                            <button onClick={() => deleteCreditNote(note.id)} className="text-red-600 hover:text-red-800" disabled={isLoading}>
                              üóëÔ∏è
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'prices' && (
                  <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-bold mb-4">Prezzi Online</h2>
                    <div className="grid grid-cols-2 gap-4">
                      {PRODUCTS.map(product => (
                        <div key={product} className="flex items-center gap-2">
                          <label className="w-48 text-sm font-medium">{product}</label>
                          <input
                            type="number"
                            step="0.01"
                            value={onlinePrices[product] || ''}
                            onChange={(e) => {
                              const updated = { ...onlinePrices, [product]: parseFloat(e.target.value) || 0 };
                              setOnlinePrices(updated);
                            }}
                            onBlur={(e) => e.target.value && updateOnlinePrice(product, e.target.value)}
                            placeholder="0.00"
                            className="flex-1 px-3 py-2 border rounded"
                            disabled={isLoading}
                          />
                          <span className="text-sm text-gray-500">‚Ç¨</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b29aa319d46ea45',t:'MTc2NjUxMTg0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>