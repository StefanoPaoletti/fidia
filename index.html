<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Prezzi Fidia</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="root"></div>
   
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
       
        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ];
        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];
        const SHEET_ID = '1FvExAXdbcPeA3vowfpVm1D4IO68GYF4s5GpzesvAJu8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX5dwnxE0LeYXgpBTvOZ5l6RR63JLw5qSQQBAcREdrw2DFc6fz9RZELn_noz1qxq2v/exec';

        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [isLoading, setIsLoading] = useState(false);

          // Form fattura
          const [invoiceDate, setInvoiceDate] = useState('');
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [invoiceYear, setInvoiceYear] = useState(new Date().getFullYear().toString());
          const [shippingCost, setShippingCost] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([
            { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }
          ]);
          const [editingInvoice, setEditingInvoice] = useState(null);

          // Form nota credito
          const [creditYear, setCreditYear] = useState(new Date().getFullYear().toString());
          const [creditAmount, setCreditAmount] = useState('');

          // Timer per prezzi online
          const priceTimerRef = useRef(null);

          useEffect(() => {
            const stored = localStorage.getItem('fidiaAppPassword');
            if (stored) {
              setSavedPassword(stored);
              setIsAuthenticated(true);
              loadFromGoogleSheets(stored);
            }
          }, []);

          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            if (!pwd) return;
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL + '?password=' + encodeURIComponent(pwd));
              if (!response.ok) throw new Error('Errore server');
              const data = await response.json();

              if (data.success === false || data.error === "Password errata") {
                alert('Password errata. Reinseriscila.');
                handleLogout();
                return;
              }

              const invoiceMap = {};
              data.invoices.forEach(row => {
                if (!invoiceMap[row.id]) {
                  invoiceMap[row.id] = {
                    id: row.id,
                    year: row.year,
                    date: row.date,
                    number: row.number,
                    shippingCost: row.shippingCost || 0,
                    items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product,
                  quantity: row.quantity,
                  price: row.priceGross,
                  discount: row.discount || 0,
                  vat: row.vat,
                  freebies: row.freebies,
                  priceNet: row.priceNet,
                  shippingCost: row.shippingCost || 0
                });
              });

              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes || []);
              setOnlinePrices(data.onlinePrices || {});
            } catch (error) {
              console.error(error);
              alert('Errore di connessione o password errata.');
              handleLogout();
            }
            setIsLoading(false);
          };

          const saveToGoogleSheets = async (action, payload) => {
            if (!savedPassword) return false;
            setIsLoading(true);
            try {
              await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: savedPassword, action, ...payload }),
                mode: 'no-cors'
              });
              await new Promise(r => setTimeout(r, 1200));
              await loadFromGoogleSheets();
              return true;
            } catch (error) {
              console.error(error);
              alert('Errore salvataggio: ' + error.message);
              setIsLoading(false);
              return false;
            }
          };

          const handleLogin = () => {
            if (!password) return alert('Inserisci la password!');
            localStorage.setItem('fidiaAppPassword', password);
            setSavedPassword(password);
            setIsAuthenticated(true);
            loadFromGoogleSheets(password);
          };

          const handleLogout = () => {
            localStorage.removeItem('fidiaAppPassword');
            setSavedPassword('');
            setIsAuthenticated(false);
            setPassword('');
            setInvoices([]);
            setCreditNotes([]);
            setOnlinePrices({});
          };

          const addInvoiceItem = () => setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          const removeInvoiceItem = index => setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
          const updateInvoiceItem = (index, field, value) => {
            const updated = [...invoiceItems];
            updated[index][field] = value;
            setInvoiceItems(updated);
          };

          const resetForm = () => {
            setEditingInvoice(null);
            setInvoiceDate('');
            setInvoiceNumber('');
            setShippingCost('');
            setInvoiceYear(new Date().getFullYear().toString());
            setInvoiceItems([{ product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          };

          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');

            const shipping = parseFloat(shippingCost) || 0;
            const newInvoice = {
              id: Date.now(),
              date: invoiceDate,
              number: invoiceNumber,
              year: invoiceYear,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };

            const success = await saveToGoogleSheets('saveInvoice', newInvoice);
            if (success) {
              resetForm();
              alert('Fattura salvata con successo!');
            }
          };

          const updateInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');

            const shipping = parseFloat(shippingCost) || 0;
            const updatedInvoice = {
              id: editingInvoice.id,
              date: invoiceDate,
              number: invoiceNumber,
              year: invoiceYear,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };

            const success = await saveToGoogleSheets('updateInvoice', updatedInvoice);
            if (success) {
              resetForm();
              alert('Fattura aggiornata con successo!');
            }
          };

          const deleteInvoice = async (id) => {
            if (!confirm('Eliminare definitivamente questa fattura?')) return;
            await saveToGoogleSheets('deleteInvoice', { id });
          };

          const startEditInvoice = (invoice) => {
            setEditingInvoice(invoice);
            setInvoiceYear(invoice.year);
            setInvoiceDate(invoice.date);
            setInvoiceNumber(invoice.number);
            setShippingCost(invoice.shippingCost || '');
            setInvoiceItems(invoice.items.map(item => ({
              product: item.product,
              quantity: item.quantity,
              price: item.price,
              discount: item.discount || '',
              vat: item.vat || '10',
              freebies: item.freebies || ''
            })));
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };

          const saveCreditNote = async () => {
            if (!creditAmount || parseFloat(creditAmount) <= 0) return alert('Inserisci un importo valido');
            const newNote = {
              id: Date.now(),
              year: creditYear,
              amount: parseFloat(creditAmount)
            };
            const success = await saveToGoogleSheets('saveCreditNote', newNote);
            if (success) {
              setCreditAmount('');
              alert('Nota di credito salvata!');
            }
          };

          const deleteCreditNote = async (id) => {
            if (!confirm('Eliminare questa nota di credito?')) return;
            await saveToGoogleSheets('deleteCreditNote', { id });
          };

          const handlePriceChange = (product, value) => {
            const newPrices = { ...onlinePrices, [product]: parseFloat(value) || 0 };
            setOnlinePrices(newPrices);

            if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
            priceTimerRef.current = setTimeout(() => {
              if (value !== '') {
                saveToGoogleSheets('saveOnlinePrice', { product, price: parseFloat(value) || 0 });
              }
            }, 2000);
          };

          const exportDashboardImage = async () => {
            const el = document.getElementById('dashboard-table');
            if (!el) return alert('Errore: tabella non trovata');
            try {
              const canvas = await html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });
              const link = document.createElement('a');
              link.download = `analisi-margini-${selectedYear}-${new Date().toISOString().split('T')[0]}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            } catch (err) {
              alert('Errore esportazione immagine');
            }
          };

          // Analisi ottimizzata con useMemo
          const analysis = useMemo(() => {
            const result = {};
            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQuantity = 0;
              let yearCost = {};
              let yearQuantity = {};

              const filteredInvoices = selectedYear === 'all'
                ? invoices
                : invoices.filter(inv => String(inv.year) === selectedYear);

              filteredInvoices.forEach(invoice => {
                const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                const shipping = parseFloat(invoice.shippingCost) || 0;

                invoice.items.forEach(item => {
                  if (item.product !== product) return;

                  const qty = parseFloat(item.quantity) || 0;
                  const free = parseFloat(item.freebies) || 0;
                  const netPrice = parseFloat(item.priceNet || item.price) || 0;
                  const vat = parseFloat(item.vat) || 0;
                  const totalQty = qty + free;

                  const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;

                  const priceWithVAT = qty * netPrice * (1 + vat / 100);
                  const shippingWithVAT = shippingShare * 1.22;
                  const itemCost = priceWithVAT + shippingWithVAT;

                  totalCost += itemCost;
                  totalQuantity += totalQty;

                  if (!yearCost[invoice.year]) yearCost[invoice.year] = 0;
                  if (!yearQuantity[invoice.year]) yearQuantity[invoice.year] = 0;
                  yearCost[invoice.year] += itemCost;
                  yearQuantity[invoice.year] += totalQty;
                });
              });

              // Note di credito proporzionali
              const relevantCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(c => c.year === selectedYear);
              const totalAllYearsCost = Object.values(yearCost).reduce((a, b) => a + b, 0);
              relevantCredits.forEach(c => {
                if (yearCost[c.year] && totalAllYearsCost > 0) {
                  const prop = yearCost[c.year] / totalAllYearsCost;
                  yearCost[c.year] -= c.amount * prop;
                }
              });

              const finalCost = Object.values(yearCost).reduce((a, b) => a + b, 0);
              const avgCost = totalQuantity > 0 ? finalCost / totalQuantity : 0;
              const online = onlinePrices[product] || 0;
              const margin = online > 0 ? ((online - avgCost) / online) * 100 : 0;

              result[product] = { avgRealCost: avgCost, onlinePrice: online, margin, totalQuantity };
            });
            return result;
          }, [invoices, creditNotes, onlinePrices, selectedYear]);

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Analisi Prezzi Fidia</h1>
                  <div className="space-y-4">
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                        onKeyPress={e => e.key === 'Enter' && handleLogin()}
                        placeholder="Inserisci password"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                      <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-600">
                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                      </button>
                    </div>
                    <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                      Accedi
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-lg p-8 flex items-center gap-4 shadow-2xl">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
                    <span className="text-xl font-medium">Sincronizzazione con Google Sheets...</span>
                  </div>
                </div>
              )}

              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-gray-800">Analisi Prezzi Fidia</h1>
                    <div className="flex gap-3 items-center">
                      <button onClick={loadFromGoogleSheets} disabled={isLoading} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        üîÑ Ricarica
                      </button>
                      <a href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`} target="_blank" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Apri Sheets
                      </a>
                      <button onClick={handleLogout} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Logout
                      </button>
                    </div>
                  </div>
                  <div className="flex gap-4 mt-6 overflow-x-auto pb-2">
                    {['dashboard', 'invoices', 'credits', 'prices'].map(tab => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-6 py-2 rounded font-medium whitespace-nowrap ${activeTab === tab ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                      >
                        {tab === 'dashboard' ? 'Dashboard' : tab === 'invoices' ? 'Fatture' : tab === 'credits' ? 'Note Credito' : 'Prezzi Online'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-8">
                {/* DASHBOARD */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-8">
                    <div className="bg-white rounded-lg shadow p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">Analisi Margini</h2>
                        <div className="flex gap-4 items-center">
                          <select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="px-4 py-2 border rounded-lg">
                            <option value="all">Tutti gli anni</option>
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                          <button onClick={exportDashboardImage} className="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                            üì∏ Esporta Immagine
                          </button>
                        </div>
                      </div>

                      <div id="dashboard-table" className="overflow-x-auto">
                        {/* Statistiche omaggi */}
                        {(() => {
                          const filtered = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
                          let totalFree = 0, totalFreeValue = 0, totalPurchaseValue = 0;
                          filtered.forEach(inv => {
                            inv.items.forEach(item => {
                              const qty = parseFloat(item.quantity) || 0;
                              const free = parseFloat(item.freebies) || 0;
                              const net = parseFloat(item.priceNet || item.price) || 0;
                              const vat = parseFloat(item.vat) || 0;
                              const priceIVA = net * (1 + vat / 100);
                              totalFree += free;
                              totalFreeValue += free * priceIVA;
                              totalPurchaseValue += qty * priceIVA;
                            });
                          });
                          const perc = totalPurchaseValue > 0 ? (totalFreeValue / totalPurchaseValue) * 100 : 0;
                          return totalFree > 0 && (
                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-300 rounded-lg p-5 mb-6">
                              <h3 className="font-bold text-green-800 mb-4 text-lg">Statistiche Omaggi {selectedYear !== 'all' ? selectedYear : ''}</h3>
                              <div className="grid grid-cols-3 gap-6">
                                <div className="text-center">
                                  <div className="text-3xl font-bold text-green-700">{totalFree}</div>
                                  <div className="text-gray-600">Pezzi omaggio</div>
                                </div>
                                <div className="text-center">
                                  <div className="text-3xl font-bold text-green-700">‚Ç¨ {totalFreeValue.toFixed(2)}</div>
                                  <div className="text-gray-600">Valore omaggi</div>
                                </div>
                                <div className="text-center">
                                  <div className="text-3xl font-bold text-green-700">{perc.toFixed(1)}%</div>
                                  <div className="text-gray-600">Sconto in merce</div>
                                </div>
                              </div>
                            </div>
                          );
                        })()}

                        <table className="w-full text-sm">
                          <thead className="bg-gray-100">
                            <tr>
                              <th className="px-4 py-3 text-left font-medium">Prodotto</th>
                              <th className="px-4 py-3 text-right font-medium">Costo Reale ‚Ç¨</th>
                              <th className="px-4 py-3 text-right font-medium">Prezzo Online ‚Ç¨</th>
                              <th className="px-4 py-3 text-right font-medium">Margine %</th>
                              <th className="px-4 py-3 text-right font-medium">Qt√† Totale</th>
                              <th className="px-4 py-3 text-center font-medium">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {Object.entries(analysis)
                              .filter(([, d]) => d.totalQuantity > 0)
                              .sort(([, a], [, b]) => a.margin - b.margin)
                              .map(([product, data]) => (
                                <tr key={product} className="border-b hover:bg-gray-50">
                                  <td className="px-4 py-3 font-medium">{product}</td>
                                  <td className="px-4 py-3 text-right">{data.avgRealCost.toFixed(2)}</td>
                                  <td className="px-4 py-3 text-right">{data.onlinePrice.toFixed(2)}</td>
                                  <td className={`px-4 py-3 text-right font-bold ${data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                    {data.margin.toFixed(1)}%
                                  </td>
                                  <td className="px-4 py-3 text-right">{data.totalQuantity}</td>
                                  <td className="px-4 py-3 text-center">
                                    {data.margin < 20 ? '‚ö†Ô∏è Basso' : data.margin < 30 ? 'üìä Medio' : '‚úÖ Buono'}
                                  </td>
                                </tr>
                              ))}

                            {(() => {
                              const activeProducts = Object.entries(analysis).filter(([, d]) => d.totalQuantity > 0);
                              const revenue = activeProducts.reduce((s, [, d]) => s + d.onlinePrice * d.totalQuantity, 0);
                              const cost = activeProducts.reduce((s, [, d]) => s + d.avgRealCost * d.totalQuantity, 0);
                              const weightedMargin = revenue > 0 ? ((revenue - cost) / revenue) * 100 : 0;
                              return (
                                <>
                                  <tr className="border-t-4 border-gray-400 bg-gray-100 font-bold">
                                    <td colSpan={6} className="py-3"></td>
                                  </tr>
                                  <tr className="bg-blue-50 font-bold">
                                    <td className="px-4 py-3">STIMA INCASSO</td>
                                    <td colSpan={2} className="px-4 py-3 text-right">‚Ç¨ {revenue.toFixed(2)}</td>
                                    <td colSpan={3}></td>
                                  </tr>
                                  <tr className="bg-orange-50 font-bold">
                                    <td className="px-4 py-3">COSTO TOTALE REALE</td>
                                    <td colSpan={2} className="px-4 py-3 text-right">‚Ç¨ {cost.toFixed(2)}</td>
                                    <td colSpan={3}></td>
                                  </tr>
                                  <tr className={`font-bold text-xl ${weightedMargin < 20 ? 'bg-red-100' : weightedMargin < 30 ? 'bg-yellow-100' : 'bg-green-100'}`}>
                                    <td className="px-4 py-4">MARGINE MEDIO PONDERATO</td>
                                    <td colSpan={2}></td>
                                    <td className={`px-4 py-4 text-right ${weightedMargin < 20 ? 'text-red-600' : weightedMargin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                      {weightedMargin.toFixed(1)}%
                                    </td>
                                    <td colSpan={2} className="px-4 py-4 text-center text-3xl">
                                      {weightedMargin < 20 ? '‚ùå' : weightedMargin < 30 ? '‚ö†Ô∏è' : '‚úÖ'}
                                    </td>
                                  </tr>
                                </>
                              );
                            })()}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* FATTURE */}
                {activeTab === 'invoices' && (
                  <div className="space-y-8">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-6">
                        {editingInvoice ? '‚úèÔ∏è Modifica Fattura' : 'üìÑ Nuova Fattura'}
                      </h2>
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={invoiceYear} onChange={e => setInvoiceYear(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Data Fattura</label>
                          <input type="date" value={invoiceDate} onChange={e => setInvoiceDate(e.target.value)} className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={invoiceNumber} onChange={e => setInvoiceNumber(e.target.value)} placeholder="es. 3060003884" className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Spese Spedizione ‚Ç¨</label>
                          <input type="number" step="0.01" value={shippingCost} onChange={e => setShippingCost(e.target.value)} placeholder="0.00" className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                      </div>

                      {shippingCost && parseFloat(shippingCost) > 0 && (
                        <div className="mb-6 p-4 bg-blue-50 border border-blue-300 rounded-lg text-blue-800">
                          ‚ÑπÔ∏è Le spese di spedizione (‚Ç¨{parseFloat(shippingCost).toFixed(2)}) saranno ripartite proporzionalmente al numero di pezzi (IVA 22%).
                        </div>
                      )}

                      <div className="overflow-x-auto mb-6">
                        <table className="w-full">
                          <thead className="bg-gray-100">
                            <tr>
                              <th className="px-3 py-2 text-left">Qt√†</th>
                              <th className="px-3 py-2 text-left">Prodotto</th>
                              <th className="px-3 py-2 text-left">Prezzo Unit. ‚Ç¨</th>
                              <th className="px-3 py-2 text-left">Sconto %</th>
                              <th className="px-3 py-2 text-left">IVA %</th>
                              <th className="px-3 py-2 text-left">Omaggi</th>
                              <th className="px-3 py-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {invoiceItems.map((item, i) => (
                              <tr key={i} className="border-b">
                                <td className="px-3 py-2"><input type="number" value={item.quantity} onChange={e => updateInvoiceItem(i, 'quantity', e.target.value)} className="w-full px-2 py-1 border rounded" /></td>
                                <td className="px-3 py-2">
                                  <select value={item.product} onChange={e => updateInvoiceItem(i, 'product', e.target.value)} className="w-full px-2 py-1 border rounded">
                                    <option value="">Seleziona...</option>
                                    {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                                  </select>
                                </td>
                                <td className="px-3 py-2"><input type="number" step="0.01" value={item.price} onChange={e => updateInvoiceItem(i, 'price', e.target.value)} placeholder="lordo" className="w-full px-2 py-1 border rounded" /></td>
                                <td className="px-3 py-2"><input type="number" step="0.01" value={item.discount} onChange={e => updateInvoiceItem(i, 'discount', e.target.value)} placeholder="0" className="w-full px-2 py-1 border rounded" /></td>
                                <td className="px-3 py-2">
                                  <select value={item.vat} onChange={e => updateInvoiceItem(i, 'vat', e.target.value)} className="w-full px-2 py-1 border rounded">
                                    <option value="10">10%</option>
                                    <option value="22">22%</option>
                                  </select>
                                </td>
                                <td className="px-3 py-2"><input type="number" value={item.freebies} onChange={e => updateInvoiceItem(i, 'freebies', e.target.value)} placeholder="0" className="w-full px-2 py-1 border rounded" /></td>
                                <td className="px-3 py-2 text-center"><button onClick={() => removeInvoiceItem(i)} className="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button></td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="flex gap-3">
                        <button onClick={addInvoiceItem} className="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">‚ûï Aggiungi riga</button>
                        {editingInvoice ? (
                          <>
                            <button onClick={updateInvoice} disabled={isLoading} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">‚úÖ Aggiorna</button>
                            <button onClick={resetForm} className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">‚ùå Annulla</button>
                          </>
                        ) : (
                          <button onClick={saveInvoice} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">üíæ Salva Fattura</button>
                        )}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-4">Fatture inserite ({invoices.length})</h2>
                      <div className="space-y-3">
                        {invoices.slice().sort((a, b) => b.date.localeCompare(a.date)).map(inv => (
                          <div key={inv.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start">
                            <div>
                              <div className="font-bold text-lg">{inv.number} - {inv.date} ({inv.year})</div>
                              {inv.shippingCost > 0 && <div className="text-sm text-gray-600">Spese spedizione: ‚Ç¨{inv.shippingCost.toFixed(2)}</div>}
                              <div className="text-sm text-gray-700 mt-2">
                                {inv.items.map((it, idx) => (
                                  <div key={idx}>‚Ä¢ {it.product}: {it.quantity} pz + {it.freebies || 0} omaggi @ ‚Ç¨{it.price} {it.discount > 0 && `(sconto ${it.discount}%)`}</div>
                                ))}
                              </div>
                            </div>
                            <div className="flex gap-3">
                              <button onClick={() => startEditInvoice(inv)} disabled={isLoading} className="text-blue-600 hover:text-blue-800 text-2xl">‚úèÔ∏è</button>
                              <button onClick={() => deleteInvoice(inv.id)} disabled={isLoading} className="text-red-600 hover:text-red-800 text-2xl">üóëÔ∏è</button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* NOTE DI CREDITO */}
                {activeTab === 'credits' && (
                  <div className="space-y-8">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-6">Nuova Nota di Credito</h2>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={creditYear} onChange={e => setCreditYear(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Importo ‚Ç¨</label>
                          <input type="number" step="0.01" value={creditAmount} onChange={e => setCreditAmount(e.target.value)} placeholder="es. 250.00" className="w-full px-4 py-2 border rounded-lg" />
                        </div>
                      </div>
                      <button onClick={saveCreditNote} disabled={isLoading} className="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üíæ Salva Nota di Credito
                      </button>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-4">Note di Credito Inserite ({creditNotes.length})</h2>
                      <div className="space-y-3">
                        {creditNotes.slice().sort((a, b) => b.year - a.year).map(note => (
                          <div key={note.id} className="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50">
                            <div className="font-medium text-lg">{note.year} - ‚Ç¨ {note.amount.toFixed(2)}</div>
                            <button onClick={() => deleteCreditNote(note.id)} disabled={isLoading} className="text-red-600 hover:text-red-800 text-2xl">üóëÔ∏è</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* PREZZI ONLINE */}
                {activeTab === 'prices' && (
                  <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-2xl font-bold mb-6">Prezzi Online</h2>
                    <p className="text-gray-600 mb-6">I prezzi si salvano automaticamente dopo 2 secondi dall'ultima modifica.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                      {PRODUCTS.map(product => (
                        <div key={product} className="flex items-center gap-4">
                          <label className="w-64 text-sm font-medium truncate">{product}</label>
                          <input
                            type="number"
                            step="0.01"
                            value={onlinePrices[product] || ''}
                            onChange={e => handlePriceChange(product, e.target.value)}
                            placeholder="0.00"
                            className="flex-1 px-4 py-2 border rounded-lg"
                            disabled={isLoading}
                          />
                          <span className="text-gray-500">‚Ç¨</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
