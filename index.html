<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Prezzi Fidia</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ];

        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];

        const SHEET_ID = '1FvExAXdbcPeA3vowfpVm1D4IO68GYF4s5GpzesvAJu8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIovQk-IhbkxQCH95qXVNxrnUy8PeSFTkA3ao2SVBzWYW-vGRk5nx5kBrNAZiRXpbt/exec';

        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState('2025');
          const [isLoading, setIsLoading] = useState(false);

          const [invoiceDate, setInvoiceDate] = useState('');
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [invoiceYear, setInvoiceYear] = useState('2025');
          const [invoiceItems, setInvoiceItems] = useState([
            { product: '', quantity: '', price: '', vat: '10', freebies: '' }
          ]);

          const [creditYear, setCreditYear] = useState('2025');
          const [creditAmount, setCreditAmount] = useState('');

          useEffect(() => {
            if (isAuthenticated) {
              loadFromGoogleSheets();
            }
          }, [isAuthenticated]);

          const loadFromGoogleSheets = async () => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              const data = await response.json();
              
              const invoiceMap = {};
              data.invoices.forEach(row => {
                if (!invoiceMap[row.id]) {
                  invoiceMap[row.id] = {
                    id: row.id,
                    year: row.year,
                    date: row.date,
                    number: row.number,
                    items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product,
                  quantity: row.quantity,
                  price: row.price,
                  vat: row.vat,
                  freebies: row.freebies
                });
              });
              
              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes);
              setOnlinePrices(data.onlinePrices);
            } catch (error) {
              console.error('Errore nel caricamento:', error);
              alert('Errore nel caricamento dei dati da Google Sheets');
            }
            setIsLoading(false);
          };

          const saveToGoogleSheets = async (action, data) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...data }),
                mode: 'no-cors'
              });
              
              setTimeout(async () => {
                await loadFromGoogleSheets();
              }, 1000);
              
              return true;
            } catch (error) {
              console.error('Errore nel salvataggio:', error);
              alert('Errore nel salvataggio su Google Sheets: ' + error.message);
              setIsLoading(false);
              return false;
            }
          };

          const handleLogin = () => {
            if (password === 'Fidia2026%') {
              setIsAuthenticated(true);
            } else {
              alert('Password errata!');
            }
          };

          const addInvoiceItem = () => {
            setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', vat: '10', freebies: '' }]);
          };

          const removeInvoiceItem = (index) => {
            setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
          };

          const updateInvoiceItem = (index, field, value) => {
            const updated = [...invoiceItems];
            updated[index][field] = value;
            setInvoiceItems(updated);
          };

          const saveInvoice = async () => {
            if (!invoiceDate || !invoiceNumber || invoiceItems.some(item => !item.product || !item.quantity || !item.price)) {
              alert('Compila tutti i campi obbligatori!');
              return;
            }

            const newInvoice = {
              id: Date.now(),
              date: invoiceDate,
              number: invoiceNumber,
              year: invoiceYear,
              items: invoiceItems.filter(item => item.product && item.quantity && item.price)
            };

            const success = await saveToGoogleSheets('saveInvoice', newInvoice);
            
            if (success) {
              setInvoiceDate('');
              setInvoiceNumber('');
              setInvoiceItems([{ product: '', quantity: '', price: '', vat: '10', freebies: '' }]);
              alert('Fattura salvata su Google Sheets!');
            }
          };

          const saveCreditNote = async () => {
            if (!creditAmount) {
              alert('Inserisci l\'importo!');
              return;
            }

            const newNote = {
              id: Date.now(),
              year: creditYear,
              amount: parseFloat(creditAmount)
            };

            const success = await saveToGoogleSheets('saveCreditNote', newNote);
            
            if (success) {
              setCreditAmount('');
              alert('Nota di credito salvata su Google Sheets!');
            }
          };

          const deleteInvoice = async (id) => {
            if (confirm('Sei sicuro di voler eliminare questa fattura?')) {
              await saveToGoogleSheets('deleteInvoice', { id });
            }
          };

          const deleteCreditNote = async (id) => {
            if (confirm('Sei sicuro di voler eliminare questa nota di credito?')) {
              await saveToGoogleSheets('deleteCreditNote', { id });
            }
          };

          const updateOnlinePrice = async (product, price) => {
            if (price && !isNaN(price)) {
              await saveToGoogleSheets('saveOnlinePrice', { product, price: parseFloat(price) });
            }
          };

          const calculateProductAnalysis = () => {
            const analysis = {};

            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQuantity = 0;
              let yearCost = {};
              let yearQuantity = {};

              invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const freebies = parseFloat(item.freebies) || 0;
                    const price = parseFloat(item.price) || 0;
                    const totalQty = qty + freebies;
                    
                    totalCost += qty * price;
                    totalQuantity += totalQty;

                    if (!yearCost[invoice.year]) {
                      yearCost[invoice.year] = 0;
                      yearQuantity[invoice.year] = 0;
                    }
                    yearCost[invoice.year] += qty * price;
                    yearQuantity[invoice.year] += totalQty;
                  }
                });
              });

              Object.keys(yearCost).forEach(year => {
                const yearCredit = creditNotes
                  .filter(cn => cn.year === year)
                  .reduce((sum, cn) => sum + cn.amount, 0);

                const yearTotal = Object.values(yearCost).reduce((sum, cost) => sum + cost, 0);
                if (yearTotal > 0) {
                  const proportion = yearCost[year] / yearTotal;
                  yearCost[year] -= yearCredit * proportion;
                }
              });

              const totalCostWithCredits = Object.values(yearCost).reduce((sum, cost) => sum + cost, 0);
              const avgRealCost = totalQuantity > 0 ? totalCostWithCredits / totalQuantity : 0;
              const onlinePrice = onlinePrices[product] || 0;
              const margin = onlinePrice > 0 ? ((onlinePrice - avgRealCost) / onlinePrice * 100) : 0;

              analysis[product] = {
                avgRealCost,
                onlinePrice,
                margin,
                totalQuantity,
                yearData: Object.keys(yearCost).map(year => ({
                  year,
                  cost: yearQuantity[year] > 0 ? yearCost[year] / yearQuantity[year] : 0,
                  quantity: yearQuantity[year]
                }))
              };
            });

            return analysis;
          };

          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Analisi Prezzi Fidia</h1>
                  <div className="space-y-4">
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        placeholder="Inserisci password"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <button
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                      >
                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                      </button>
                    </div>
                    <button
                      onClick={handleLogin}
                      className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                    >
                      Accedi
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          const analysis = calculateProductAnalysis();
          const filteredAnalysis = selectedYear === 'all' 
            ? analysis 
            : Object.fromEntries(
                Object.entries(analysis).map(([product, data]) => [
                  product,
                  {
                    ...data,
                    yearData: data.yearData.filter(y => y.year === selectedYear)
                  }
                ])
              );

          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed top-0 left-0 right-0 bg-blue-600 text-white py-2 text-center z-50">
                  üîÑ Sincronizzazione con Google Sheets...
                </div>
              )}
              
              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-gray-800">Analisi Prezzi Fidia</h1>
                    <div className="flex gap-2 items-center">
                      <span className="text-sm text-gray-600">üíæ Salvato su Google Sheets</span>
                      <button 
                        onClick={loadFromGoogleSheets} 
                        className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                        disabled={isLoading}
                      >
                        üîÑ Ricarica
                      </button>
                      <a 
                        href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`}
                        target="_blank"
                        className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                      >
                        üìä Apri Google Sheets
                      </a>
                    </div>
                  </div>
                  <div className="flex gap-4 mt-4">
                    <button
                      onClick={() => setActiveTab('dashboard')}
                      className={`px-4 py-2 rounded ${activeTab === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Dashboard
                    </button>
                    <button
                      onClick={() => setActiveTab('invoices')}
                      className={`px-4 py-2 rounded ${activeTab === 'invoices' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Fatture
                    </button>
                    <button
                      onClick={() => setActiveTab('credits')}
                      className={`px-4 py-2 rounded ${activeTab === 'credits' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Note Credito
                    </button>
                    <button
                      onClick={() => setActiveTab('prices')}
                      className={`px-4 py-2 rounded ${activeTab === 'prices' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                    >
                      Prezzi Online
                    </button>
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-6">
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Analisi Margini</h2>
                        <select
                          value={selectedYear}
                          onChange={(e) => setSelectedYear(e.target.value)}
                          className="px-4 py-2 border rounded"
                        >
                          <option value="all">Tutti gli anni</option>
                          {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                        </select>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="px-4 py-2 text-left">Prodotto</th>
                              <th className="px-4 py-2 text-right">Costo Reale ‚Ç¨</th>
                              <th className="px-4 py-2 text-right">Prezzo Online ‚Ç¨</th>
                              <th className="px-4 py-2 text-right">Margine %</th>
                              <th className="px-4 py-2 text-right">Qt√† Totale</th>
                              <th className="px-4 py-2 text-center">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {Object.entries(filteredAnalysis)
                              .sort(([, a], [, b]) => a.margin - b.margin)
                              .map(([product, data]) => (
                                <tr key={product} className="border-b hover:bg-gray-50">
                                  <td className="px-4 py-3 font-medium">{product}</td>
                                  <td className="px-4 py-3 text-right">{data.avgRealCost.toFixed(2)}</td>
                                  <td className="px-4 py-3 text-right">{data.onlinePrice.toFixed(2)}</td>
                                  <td className={`px-4 py-3 text-right font-bold ${data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                    {data.margin.toFixed(1)}%
                                  </td>
                                  <td className="px-4 py-3 text-right">{data.totalQuantity}</td>
                                  <td className="px-4 py-3 text-center">
                                    {data.margin < 20 ? (
                                      <span className="text-red-600">‚ö†Ô∏è Basso</span>
                                    ) : data.margin < 30 ? (
                                      <span className="text-yellow-600">üìä Medio</span>
                                    ) : (
                                      <span className="text-green-600">‚úÖ Buono</span>
                                    )}
                                  </td>
                                </tr>
                              ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'invoices' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Nuova Fattura</h2>
                      <div className="grid grid-cols-3 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={invoiceYear} onChange={(e) => setInvoiceYear(e.target.value)} className="w-full px-3 py-2 border rounded">
                            {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Data Fattura</label>
                          <input type="date" value={invoiceDate} onChange={(e) => setInvoiceDate(e.target.value)} className="w-full px-3 py-2 border rounded" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={invoiceNumber} onChange={(e) => setInvoiceNumber(e.target.value)} placeholder="es. 3060003884" className="w-full px-3 py-2 border rounded" />
                        </div>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="w-full mb-4">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="px-2 py-2 text-left">Prodotto</th>
                              <th className="px-2 py-2 text-left">Qt√† Pagata</th>
                              <th className="px-2 py-2 text-left">Prezzo Unit. ‚Ç¨</th>
                              <th className="px-2 py-2 text-left">IVA %</th>
                              <th className="px-2 py-2 text-left">Omaggi</th>
                              <th className="px-2 py-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {invoiceItems.map((item, index) => (
                              <tr key={index} className="border-b">
                                <td className="px-2 py-2">
                                  <select value={item.product} onChange={(e) => updateInvoiceItem(index, 'product', e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                    <option value="">Seleziona...</option>
                                    {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                                  </select>
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" value={item.quantity} onChange={(e) => updateInvoiceItem(index, 'quantity', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" />
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" step="0.01" value={item.price} onChange={(e) => updateInvoiceItem(index, 'price', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" />
                                </td>
                                <td className="px-2 py-2">
                                  <select value={item.vat} onChange={(e) => updateInvoiceItem(index, 'vat', e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                    <option value="10">10%</option>
                                    <option value="22">22%</option>
                                  </select>
                                </td>
                                <td className="px-2 py-2">
                                  <input type="number" value={item.freebies} onChange={(e) => updateInvoiceItem(index, 'freebies', e.target.value)} placeholder="0" className="w-full px-2 py-1 border rounded text-sm" />
                                </td>
                                <td className="px-2 py-2">
                                  <button onClick={() => removeInvoiceItem(index)} className="text-red-600 hover:text-red-800">
                                    üóëÔ∏è
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="flex gap-2">
                        <button onClick={addInvoiceItem} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                          ‚ûï Aggiungi Riga
                        </button>
                        <button onClick={saveInvoice} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled={isLoading}>
                          üíæ Salva Fattura
                        </button>
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Fatture Inserite ({invoices.length})</h2>
                      <div className="space-y-2">
                        {invoices.map(invoice => (
                          <div key={invoice.id} className="border rounded p-4 hover:bg-gray-50">
                            <div className="flex justify-between items-start">
                              <div>
                                <div className="font-bold">{invoice.number} - {invoice.date} ({invoice.year})</div>
                                <div className="text-sm text-gray-600 mt-1">
                                  {invoice.items.map((item, i) => (
                                    <div key={i}>
                                      {item.product}: {item.quantity} pz + {item.freebies || 0} omaggio @ ‚Ç¨{item.price}
                                    </div>
                                  ))}
                                </div>
                              </div>
                              <button onClick={() => deleteInvoice(invoice.id)} className="text-red-600 hover:text-red-800" disabled={isLoading}>
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'credits' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Nuova Nota di Credito</h2>
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Anno</label>
                          <select value={creditYear} onChange={(e) => setCreditYear(e.target.value)} className="w-full px-3 py-2 border rounded">
                            {YEARS.map(year => <option key={year} value={year}>{year}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Importo Bonifico ‚Ç¨</label>
                          <input type="number" step="0.01" value={creditAmount} onChange={(e) => setCreditAmount(e.target.value)} placeholder="es. 500.00" className="w-full px-3 py-2 border rounded" />
                        </div>
                      </div>
                      <button onClick={saveCreditNote} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled={isLoading}>
                        üíæ Salva
                      </button>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Note di Credito ({creditNotes.length})</h2>
                      <div className="space-y-2">
                        {creditNotes.map(note => (
                          <div key={note.id} className="border rounded p-4 hover:bg-gray-50 flex justify-between items-center">
                            <div>
                              <span className="font-bold">{note.year}</span> - ‚Ç¨{note.amount.toFixed(2)}
                            </div>
                            <button onClick={() => deleteCreditNote(note.id)} className="text-red-600 hover:text-red-800" disabled={isLoading}>
                              üóëÔ∏è
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'prices' && (
                  <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-bold mb-4">Prezzi Online</h2>
                    <div className="grid grid-cols-2 gap-4">
                      {PRODUCTS.map(product => (
                        <div key={product} className="flex items-center gap-2">
                          <label className="w-48 text-sm font-medium">{product}</label>
                          <input
                            type="number"
                            step="0.01"
                            value={onlinePrices[product] || ''}
                            onChange={(e) => {
                              const updated = { ...onlinePrices, [product]: parseFloat(e.target.value) || 0 };
                              setOnlinePrices(updated);
                            }}
                            onBlur={(e) => e.target.value && updateOnlinePrice(product, e.target.value)}
                            placeholder="0.00"
                            className="flex-1 px-3 py-2 border rounded"
                            disabled={isLoading}
                          />
                          <span className="text-sm text-gray-500">‚Ç¨</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
