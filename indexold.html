<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Fidia</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="root"></div>
 
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
     
        const PRODUCTS = [
          'PROLENS', 'OPTO RED', 'OPTO SOL', 'OPTO YAL', 'OPTO YAL CREAM', 'OPTO GEL', 'OPTO IDRO',
          'OPTO RELAX', 'OPTO VITREO', 'RESPILENS 100', 'RESPILENS 360', 'OPTO CARE', 'OPTO MYO',
          'OPTO OMEGA', 'BLU GEL', 'BLU YAL', 'IRIDIUM GARZE', 'TRIUM',
          'VITREOXIGEN', 'LUTEINOMEGA', 'MERAMIRT', 'MYRIALEN GEL',
          'MERAMIRT CM', 'MERAMIRT XG', 'LACRISEK'
        ];
        
        const YEARS = ['2019', '2020', '2021', '2022', '2023', '2024', '2025', '2026'];
        
        const SHEET_ID = '1FvExAXdbcPeA3vowfpVm1D4IO68GYF4s5GpzesvAJu8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxv9Xxi4i-Kw0pPK8Xd7YYFpqr992YCoTd7mZog77PYDlXosRMnY_3sQ6hZOC5pBgVq/exec';
        
        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [onlinePrices, setOnlinePrices] = useState({});
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [searchQuery, setSearchQuery] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          
          // Form fattura
          const [invoiceDate, setInvoiceDate] = useState('');
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [shippingCost, setShippingCost] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([
            { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }
          ]);
          const [editingInvoice, setEditingInvoice] = useState(null);
          
          // Form nota credito
          const [creditDate, setCreditDate] = useState(new Date().toISOString().split('T')[0]);
          const [creditAmount, setCreditAmount] = useState('');
          
          // Timer per prezzi online
          const priceTimerRef = useRef(null);
          
          useEffect(() => {
            const stored = localStorage.getItem('fidiaAppPassword');
            if (stored) {
              setSavedPassword(stored);
              setIsAuthenticated(true);
              loadFromGoogleSheets(stored);
            }
          }, []);
          
          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            setIsLoading(true);
            try {
              console.log('üì° Caricamento dati da:', SCRIPT_URL);
              const response = await fetch(SCRIPT_URL);
              console.log('üì• Risposta ricevuta:', response.status, response.statusText);
              
              if (!response.ok) {
                console.error('‚ùå Risposta non OK:', response.status);
                throw new Error(`Errore server: ${response.status}`);
              }
              
              const data = await response.json();
              console.log('‚úÖ Dati ricevuti:', data);
              
              const invoiceMap = {};
              (data.invoices || []).forEach(row => {
                if (!invoiceMap[row.id]) {
                  // Corregge il formato data: se √® una stringa tipo "2026-01-01", la converte correttamente
                  let dateStr = row.date;
                  if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    // Formato YYYY-MM-DD
                    dateStr = dateStr.split('T')[0]; // Rimuove eventuale parte time
                  }
                  
                  invoiceMap[row.id] = {
                    id: row.id,
                    year: row.year,
                    date: dateStr,
                    number: row.number,
                    shippingCost: row.shippingCost || 0,
                    items: []
                  };
                }
                invoiceMap[row.id].items.push({
                  product: row.product,
                  quantity: row.quantity,
                  priceGross: row.priceGross,
                  priceNet: row.priceNet,
                  discount: row.discount || 0,
                  vat: row.vat,
                  freebies: row.freebies
                });
              });
              
              setInvoices(Object.values(invoiceMap));
              setCreditNotes(data.creditNotes || []);
              setOnlinePrices(data.onlinePrices || {});
              console.log('‚úÖ Dati caricati con successo');
            } catch (error) {
              console.error('‚ùå Errore caricamento completo:', error);
              alert('Errore nel caricamento dei dati: ' + error.message);
            }
            setIsLoading(false);
          };
          
          const saveToGoogleSheets = async (action, payload, skipReload = false) => {
            if (!savedPassword) return false;
            setIsLoading(true);
            try {
              await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ password: savedPassword, action, ...payload }),
                mode: 'no-cors'
              });
              
              // Con no-cors non possiamo leggere la risposta, quindi aspettiamo
              await new Promise(r => setTimeout(r, 1500));
              
              // Ricarica solo se non √® un'azione con optimistic update
              if (!skipReload) {
                await loadFromGoogleSheets();
              } else {
                setIsLoading(false);
              }
              
              return true;
            } catch (error) {
              console.error(error);
              alert('Errore salvataggio: ' + error.message);
              setIsLoading(false);
              return false;
            }
          };
          
          const handleLogin = () => {
            if (!password) return alert('Inserisci la password!');
            localStorage.setItem('fidiaAppPassword', password);
            setSavedPassword(password);
            setIsAuthenticated(true);
            loadFromGoogleSheets(password);
          };
          
          const handleLogout = () => {
            localStorage.removeItem('fidiaAppPassword');
            setSavedPassword('');
            setIsAuthenticated(false);
            setPassword('');
            setInvoices([]);
            setCreditNotes([]);
            setOnlinePrices({});
          };
          
          const addInvoiceItem = () => setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          const removeInvoiceItem = index => setInvoiceItems(invoiceItems.filter((_, i) => i !== index));
          const updateInvoiceItem = (index, field, value) => {
            const updated = [...invoiceItems];
            updated[index][field] = value;
            setInvoiceItems(updated);
          };
          
          const resetForm = () => {
            setEditingInvoice(null);
            setInvoiceDate('');
            setInvoiceNumber('');
            setShippingCost('');
            setInvoiceItems([{ product: '', quantity: '', price: '', discount: '', vat: '10', freebies: '' }]);
          };
          
          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');
            
            const shipping = parseFloat(shippingCost) || 0;
            const year = new Date(invoiceDate).getFullYear().toString();
            
            const newInvoice = {
              id: Date.now(),
              date: invoiceDate,
              number: invoiceNumber,
              year: year,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };
            
            const success = await saveToGoogleSheets('saveInvoice', newInvoice);
            if (success) {
              resetForm();
              alert('Fattura salvata con successo!');
            }
          };
          
          const updateInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return alert('Compila tutti i campi obbligatori!');
            
            const shipping = parseFloat(shippingCost) || 0;
            const year = new Date(invoiceDate).getFullYear().toString();
            
            const updatedInvoice = {
              id: editingInvoice.id,
              date: invoiceDate,
              number: invoiceNumber,
              year: year,
              shippingCost: shipping,
              items: validItems.map(item => ({
                product: item.product,
                quantity: parseFloat(item.quantity),
                priceGross: parseFloat(item.price),
                priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100),
                discount: parseFloat(item.discount) || 0,
                vat: item.vat || '10',
                freebies: parseFloat(item.freebies) || 0
              }))
            };
            
            const success = await saveToGoogleSheets('updateInvoice', updatedInvoice);
            if (success) {
              resetForm();
              alert('Fattura aggiornata con successo!');
            }
          };
          
          const deleteInvoice = async (id) => {
            if (!confirm('Eliminare definitivamente questa fattura?')) return;
            
            // Optimistic update: aggiorna UI immediatamente
            const oldInvoices = [...invoices];
            setInvoices(invoices.filter(inv => inv.id !== id));
            
            // Salva in background senza ricaricare (skipReload = true)
            const success = await saveToGoogleSheets('deleteInvoice', { id }, true);
            
            // Se fallisce, ripristina
            if (!success) {
              setInvoices(oldInvoices);
            }
          };
          
          const startEditInvoice = (invoice) => {
            setEditingInvoice(invoice);
            // Usa direttamente la stringa data senza conversioni per evitare problemi timezone
            setInvoiceDate(invoice.date);
            setInvoiceNumber(invoice.number);
            setShippingCost(invoice.shippingCost || '');
            setInvoiceItems(invoice.items.map(item => ({
              product: item.product,
              quantity: item.quantity,
              price: item.priceGross,
              discount: item.discount || '',
              vat: item.vat || '10',
              freebies: item.freebies || ''
            })));
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          
          const saveCreditNote = async () => {
            if (!creditAmount || parseFloat(creditAmount) <= 0) return alert('Inserisci un importo valido');
            const year = new Date(creditDate).getFullYear();
            const newNote = {
              id: Date.now(),
              year: year,
              date: creditDate,
              amount: parseFloat(creditAmount)
            };
            const success = await saveToGoogleSheets('saveCreditNote', newNote);
            if (success) {
              setCreditAmount('');
              setCreditDate(new Date().toISOString().split('T')[0]);
              alert('Nota di credito salvata!');
            }
          };
          
          const deleteCreditNote = async (id) => {
            if (!confirm('Eliminare questa nota di credito?')) return;
            
            // Optimistic update: aggiorna UI immediatamente
            const oldCreditNotes = [...creditNotes];
            setCreditNotes(creditNotes.filter(note => note.id !== id));
            
            // Salva in background senza ricaricare (skipReload = true)
            const success = await saveToGoogleSheets('deleteCreditNote', { id }, true);
            
            // Se fallisce, ripristina
            if (!success) {
              setCreditNotes(oldCreditNotes);
            }
          };
          
          const handlePriceChange = (product, value) => {
            const newPrices = { ...onlinePrices, [product]: parseFloat(value) || 0 };
            setOnlinePrices(newPrices);
            if (priceTimerRef.current) clearTimeout(priceTimerRef.current);
            priceTimerRef.current = setTimeout(() => {
              if (value !== '') {
                saveToGoogleSheets('saveOnlinePrice', { product, price: parseFloat(value) || 0 });
              }
            }, 2000);
          };
          
          const exportDashboardImage = async () => {
            const el = document.getElementById('dashboard-table');
            const searchBar = document.getElementById('search-bar');
            if (!el) return alert('Errore: tabella non trovata');
            
            // Nascondi la barra di ricerca temporaneamente
            if (searchBar) searchBar.style.display = 'none';
            
            try {
              const canvas = await html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });
              const now = new Date();
              const time = `${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}`;
              const date = now.toISOString().split('T')[0];
              const link = document.createElement('a');
              link.download = `fidia-margini-${selectedYear}-${date}-${time}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            } catch (err) {
              alert('Errore esportazione immagine');
            } finally {
              // Mostra di nuovo la barra di ricerca
              if (searchBar) searchBar.style.display = 'block';
            }
          };
          
          // Analisi ottimizzata con useMemo
          const analysis = useMemo(() => {
            const result = {};
            
            const filteredInvoices = selectedYear === 'all'
              ? invoices
              : invoices.filter(inv => String(inv.year) === selectedYear);
            
            // ‚úÖ PRE-CALCOLO: Totale costi per anno (una volta sola!)
            const totalCostByYear = {};
            filteredInvoices.forEach(invoice => {
              const year = String(invoice.year);
              if (!totalCostByYear[year]) totalCostByYear[year] = 0;
              
              const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
              const shipping = parseFloat(invoice.shippingCost) || 0;
              
              invoice.items.forEach(item => {
                const qty = parseFloat(item.quantity) || 0;
                const free = parseFloat(item.freebies) || 0;
                const netPrice = parseFloat(item.priceNet || item.price) || 0;
                const vat = parseFloat(item.vat) || 0;
                const totalQty = qty + free;
                const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                const priceWithVAT = qty * netPrice * (1 + vat / 100);
                const shippingWithVAT = shippingShare * 1.22;
                totalCostByYear[year] += priceWithVAT + shippingWithVAT;
              });
            });
            
            PRODUCTS.forEach(product => {
              let totalCost = 0;
              let totalQuantity = 0;
              let yearCost = {};
              let yearQuantity = {};
              
              filteredInvoices.forEach(invoice => {
                const totalPieces = invoice.items.reduce((sum, i) => sum + (parseFloat(i.quantity) || 0) + (parseFloat(i.freebies) || 0), 0);
                const shipping = parseFloat(invoice.shippingCost) || 0;
                
                invoice.items.forEach(item => {
                  if (item.product !== product) return;
                  
                  const qty = parseFloat(item.quantity) || 0;
                  const free = parseFloat(item.freebies) || 0;
                  const netPrice = parseFloat(item.priceNet || item.price) || 0;
                  const vat = parseFloat(item.vat) || 0;
                  const totalQty = qty + free;
                  
                  const shippingShare = totalPieces > 0 ? (totalQty / totalPieces) * shipping : 0;
                  const priceWithVAT = qty * netPrice * (1 + vat / 100);
                  const shippingWithVAT = shippingShare * 1.22;
                  const itemCost = priceWithVAT + shippingWithVAT;
                  
                  totalCost += itemCost;
                  totalQuantity += totalQty;
                  
                  if (!yearCost[invoice.year]) yearCost[invoice.year] = 0;
                  if (!yearQuantity[invoice.year]) yearQuantity[invoice.year] = 0;
                  yearCost[invoice.year] += itemCost;
                  yearQuantity[invoice.year] += totalQty;
                });
              });
              
              // Note di credito proporzionali per anno
              const relevantCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(c => String(c.year) === selectedYear);
              
              relevantCredits.forEach(c => {
                const creditYear = String(c.year);
                if (yearCost[creditYear] && totalCostByYear[creditYear]) {
                  // ‚úÖ Usa il pre-calcolo invece di ricalcolare!
                  const prop = yearCost[creditYear] / totalCostByYear[creditYear];
                  yearCost[creditYear] -= c.amount * prop;
                }
              });
              
              const finalCost = Object.values(yearCost).reduce((a, b) => a + b, 0);
              const avgCost = totalQuantity > 0 ? finalCost / totalQuantity : 0;
              const online = onlinePrices[product] || 0;
              const margin = online > 0 ? ((online - avgCost) / online) * 100 : 0;
              
              result[product] = { avgRealCost: avgCost, onlinePrice: online, margin, totalQuantity };
            });
            
            return result;
          }, [invoices, creditNotes, onlinePrices, selectedYear]);
          
          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                  <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Analisi Fidia</h1>
                  <div className="space-y-4">
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                        onKeyPress={e => e.key === 'Enter' && handleLogin()}
                        placeholder="Inserisci password"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                      <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-600">
                        {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                      </button>
                    </div>
                    <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                      Accedi
                    </button>
                  </div>
                </div>
              </div>
            );
          }
          
          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-lg p-8 flex items-center gap-4 shadow-2xl">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
                    <span className="text-xl font-medium">Sincronizzazione...</span>
                  </div>
                </div>
              )}
              
              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-3 sm:py-4">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h1 className="text-xl sm:text-2xl font-bold text-gray-800">Analisi Fidia</h1>
                    <div className="flex gap-2 items-center flex-wrap">
                      <button onClick={loadFromGoogleSheets} disabled={isLoading} className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        <span>Ricarica</span>
                      </button>
                      <a href={`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`} target="_blank" className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm whitespace-nowrap">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
                        </svg>
                        <span>Sheets</span>
                      </a>
                      <button onClick={handleLogout} className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" />
                        </svg>
                        <span>Logout</span>
                      </button>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-4 sm:mt-6 overflow-x-auto pb-2 -mx-4 px-4">
                    {['dashboard', 'invoices', 'credits', 'prices'].map(tab => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-6 py-2 rounded-lg font-medium whitespace-nowrap transition-all ${activeTab === tab ? 'bg-blue-600 text-white shadow-lg shadow-blue-300' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                      >
                        {tab === 'dashboard' ? 'Dashboard' : tab === 'invoices' ? 'Fatture' : tab === 'credits' ? 'Note Credito' : 'Prezzi Online'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="max-w-7xl mx-auto px-4 py-8">
                {/* DASHBOARD */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    {/* HEADER CON FILTRI */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <h2 className="text-2xl font-bold text-gray-800">Analisi Margini</h2>
                        <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center w-full sm:w-auto">
                          <select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="px-4 py-2.5 border rounded-lg text-base bg-white font-medium">
                            <option value="all">Tutti gli anni</option>
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                          <button onClick={exportDashboardImage} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                              <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                            </svg>
                            <span>Esporta Immagine</span>
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="dashboard-table">
                      {/* STATISTICHE PRINCIPALI - CARDS */}
                      {(() => {
                        const activeProducts = Object.entries(analysis).filter(([, d]) => d.totalQuantity > 0);
                        const revenue = activeProducts.reduce((s, [, d]) => s + d.onlinePrice * d.totalQuantity, 0);
                        const cost = activeProducts.reduce((s, [, d]) => s + d.avgRealCost * d.totalQuantity, 0);
                        const weightedMargin = revenue > 0 ? ((revenue - cost) / revenue) * 100 : 0;
                        
                        const filtered = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
                        let totalFree = 0, totalFreeValue = 0, totalPurchaseValue = 0;
                        
                        filtered.forEach(inv => {
                          inv.items.forEach(item => {
                            const qty = parseFloat(item.quantity) || 0;
                            const free = parseFloat(item.freebies) || 0;
                            const net = parseFloat(item.priceNet || item.price) || 0;
                            const vat = parseFloat(item.vat) || 0;
                            const priceIVA = net * (1 + vat / 100);
                            totalFree += free;
                            totalFreeValue += free * priceIVA;
                            totalPurchaseValue += qty * priceIVA;
                          });
                        });
                        
                        const percOmaggi = totalPurchaseValue > 0 ? (totalFreeValue / totalPurchaseValue) * 100 : 0;
                        
                        return (
                          <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
                            {/* TOTALE FATTURE */}
                            <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-orange-500">
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Totale Fatture</div>
                              <div className="text-lg sm:text-2xl font-bold text-orange-600 break-words">‚Ç¨ {cost.toFixed(2)}</div>
                            </div>
                            
                            {/* INCASSO POTENZIALE */}
                            <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-blue-500">
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Incasso Potenziale</div>
                              <div className="text-lg sm:text-2xl font-bold text-blue-600 break-words">‚Ç¨ {revenue.toFixed(2)}</div>
                            </div>
                            
                            {/* MARGINE MEDIO */}
                            <div className={`bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 ${weightedMargin < 20 ? 'border-red-500' : weightedMargin < 30 ? 'border-yellow-500' : 'border-green-500'}`}>
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Margine Medio</div>
                              <div className={`text-lg sm:text-2xl font-bold ${weightedMargin < 20 ? 'text-red-600' : weightedMargin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                {weightedMargin.toFixed(1)}%
                              </div>
                              <div className="text-xs text-gray-500 mt-1">
                                {weightedMargin < 20 ? 'Basso' : weightedMargin < 30 ? 'Medio' : 'Ottimo'}
                              </div>
                            </div>
                            
                            {/* OMAGGI */}
                            {totalFree > 0 && (
                              <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-emerald-500">
                                <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Omaggi {selectedYear !== 'all' ? selectedYear : ''}</div>
                                <div className="text-lg sm:text-2xl font-bold text-emerald-600">{percOmaggi.toFixed(1)}%</div>
                                <div className="text-xs text-gray-500 mt-1">
                                  {totalFree} pz ‚Ä¢ ‚Ç¨ {totalFreeValue.toFixed(2)}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })()}
                      
                      {/* BARRA DI RICERCA PRODOTTI */}
                      <div id="search-bar" className="bg-white rounded-lg shadow p-4">
                        <div className="relative">
                          <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                          </svg>
                          <input
                            type="text"
                            placeholder="Cerca prodotto..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                          {searchQuery && (
                            <button
                              onClick={() => setSearchQuery('')}
                              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            >
                              ‚úï
                            </button>
                          )}
                        </div>
                      </div>
                      
                      {/* TABELLA PRODOTTI */}
                      <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm sm:text-base">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-left font-semibold whitespace-nowrap text-sm sm:text-base">Prodotto</th>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-right font-semibold whitespace-nowrap text-sm sm:text-base">Costo Reale ‚Ç¨</th>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-right font-semibold whitespace-nowrap text-sm sm:text-base">Prezzo Online ‚Ç¨</th>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-right font-semibold whitespace-nowrap text-sm sm:text-base">Margine %</th>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-right font-semibold whitespace-nowrap text-sm sm:text-base">Qt√† Totale</th>
                                <th className="px-3 sm:px-5 py-3 sm:py-4 text-center font-semibold whitespace-nowrap text-sm sm:text-base">Status</th>
                              </tr>
                            </thead>
                            <tbody>
                              {Object.entries(analysis)
                                .filter(([, d]) => d.totalQuantity > 0)
                                .filter(([product]) => product.toLowerCase().includes(searchQuery.toLowerCase()))
                                .sort(([, a], [, b]) => a.margin - b.margin)
                                .map(([product, data]) => (
                                  <tr key={product} className="border-b hover:bg-gray-50">
                                    <td className="px-3 sm:px-5 py-3 sm:py-4 font-semibold whitespace-nowrap text-sm sm:text-base">{product}</td>
                                    <td className="px-3 sm:px-5 py-3 sm:py-4 text-right text-sm sm:text-base">{data.avgRealCost.toFixed(2)}</td>
                                    <td className="px-3 sm:px-5 py-3 sm:py-4 text-right text-sm sm:text-base">{data.onlinePrice.toFixed(2)}</td>
                                    <td className={`px-3 sm:px-5 py-3 sm:py-4 text-right font-bold text-sm sm:text-base ${data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600'}`}>
                                      {data.margin.toFixed(1)}%
                                    </td>
                                    <td className="px-3 sm:px-5 py-3 sm:py-4 text-right text-sm sm:text-base">{data.totalQuantity}</td>
                                    <td className="px-3 sm:px-5 py-3 sm:py-4 text-center text-xs sm:text-sm">
                                      <span className={`px-2 sm:px-3 py-1 rounded whitespace-nowrap font-medium ${data.margin < 20 ? 'bg-red-100 text-red-700' : data.margin < 30 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>
                                        {data.margin < 20 ? 'Basso' : data.margin < 30 ? 'Medio' : 'Buono'}
                                      </span>
                                    </td>
                                  </tr>
                                ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* FATTURE */}
                {activeTab === 'invoices' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">
                        {editingInvoice ? 'Modifica Fattura' : 'Nuova Fattura'}
                      </h2>
                      
                      {/* INFO FATTURA */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
                        <div>
                          <label className="block text-sm font-medium mb-1">Data Fattura</label>
                          <div className="flex justify-center sm:justify-start">
                            <input type="date" value={invoiceDate} onChange={e => setInvoiceDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Numero Fattura</label>
                          <input type="text" value={invoiceNumber} onChange={e => setInvoiceNumber(e.target.value)} placeholder="es. 3060003884" className="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" />
                        </div>
                        <div className="sm:col-span-2 lg:col-span-1">
                          <label className="block text-sm font-medium mb-1">Spese Spedizione ‚Ç¨</label>
                          <input type="number" step="0.01" value={shippingCost} onChange={e => setShippingCost(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" />
                        </div>
                      </div>
                      
                      {shippingCost && parseFloat(shippingCost) > 0 && (
                        <div className="mb-4 sm:mb-6 p-3 sm:p-4 bg-blue-50 border border-blue-300 rounded-lg text-blue-800 text-sm">
                          ‚ÑπÔ∏è Le spese di spedizione (‚Ç¨{parseFloat(shippingCost).toFixed(2)}) saranno ripartite proporzionalmente (IVA 22%).
                        </div>
                      )}
                      
                      {/* TABELLA PRODOTTI */}
                      <div className="overflow-x-auto mb-4 sm:mb-6 -mx-4 sm:mx-0">
                        <div className="inline-block min-w-full align-middle px-4 sm:px-0">
                          <table className="min-w-full text-sm">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">Quantit√†</th>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">Prodotto</th>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">Prezzo Unit. ‚Ç¨</th>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">Sconto %</th>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">IVA %</th>
                                <th className="px-3 py-2 text-left font-semibold text-xs sm:text-sm whitespace-nowrap">Omaggi</th>
                                <th className="px-3 py-2"></th>
                              </tr>
                            </thead>
                            <tbody>
                              {invoiceItems.map((item, i) => (
                                <tr key={i} className="border-b hover:bg-gray-50">
                                  <td className="px-3 py-2">
                                    <input 
                                      type="number" 
                                      value={item.quantity} 
                                      onChange={e => updateInvoiceItem(i, 'quantity', e.target.value)} 
                                      placeholder="es. 24"
                                      className="w-20 sm:w-24 px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                    />
                                  </td>
                                  <td className="px-3 py-2">
                                    <select 
                                      value={item.product} 
                                      onChange={e => updateInvoiceItem(i, 'product', e.target.value)} 
                                      className="w-32 sm:w-full px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                    >
                                      <option value="">Seleziona prodotto</option>
                                      {PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                  </td>
                                  <td className="px-3 py-2">
                                    <input 
                                      type="number" 
                                      step="0.01" 
                                      value={item.price} 
                                      onChange={e => updateInvoiceItem(i, 'price', e.target.value)} 
                                      placeholder="es. 9.46" 
                                      className="w-24 sm:w-28 px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                    />
                                  </td>
                                  <td className="px-3 py-2">
                                    <input 
                                      type="number" 
                                      step="0.01" 
                                      value={item.discount} 
                                      onChange={e => updateInvoiceItem(i, 'discount', e.target.value)} 
                                      placeholder="0" 
                                      className="w-16 sm:w-20 px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                    />
                                  </td>
                                  <td className="px-3 py-2">
                                    <select 
                                      value={item.vat} 
                                      onChange={e => updateInvoiceItem(i, 'vat', e.target.value)} 
                                      className="w-20 sm:w-24 px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                    >
                                      <option value="10">10%</option>
                                      <option value="22">22%</option>
                                    </select>
                                  </td>
                                  <td className="px-3 py-2">
                                    <input 
                                      type="number" 
                                      value={item.freebies} 
                                      onChange={e => updateInvoiceItem(i, 'freebies', e.target.value)} 
                                      placeholder="0" 
                                      className="w-16 sm:w-20 px-2 sm:px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500" 
                                    />
                                  </td>
                                  <td className="px-3 py-2 text-center">
                                    <button 
                                      onClick={() => removeInvoiceItem(i)} 
                                      className="w-8 h-8 flex items-center justify-center text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all mx-auto"
                                      title="Elimina riga"
                                    >
                                      <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                      </svg>
                                    </button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* BOTTONI */}
                      <div className="flex flex-col sm:flex-row gap-3">
                        <button onClick={addInvoiceItem} className="px-5 py-2.5 bg-white text-gray-700 rounded-lg hover:bg-gray-50 font-medium flex items-center justify-center gap-2 border-2 border-gray-300 transition-all hover:border-gray-400">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                          </svg>
                          Aggiungi Riga
                        </button>
                        {editingInvoice ? (
                          <>
                            <button onClick={updateInvoice} disabled={isLoading} className="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-all shadow-sm hover:shadow">
                              Aggiorna Fattura
                            </button>
                            <button onClick={resetForm} className="px-5 py-2.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium transition-all">
                              Annulla
                            </button>
                          </>
                        ) : (
                          <button onClick={saveInvoice} disabled={isLoading} className="flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-all shadow-sm hover:shadow">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                            </svg>
                            Salva Fattura
                          </button>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-4">Fatture inserite ({invoices.length})</h2>
                      <div className="space-y-3">
                        {invoices.slice().sort((a, b) => b.date.localeCompare(a.date)).map(inv => (
                          <div key={inv.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start">
                            <div>
                              <div className="font-bold text-lg">{inv.number} - {inv.date} ({inv.year})</div>
                              {inv.shippingCost > 0 && <div className="text-sm text-gray-600">Spese spedizione: ‚Ç¨{inv.shippingCost.toFixed(2)}</div>}
                              <div className="text-sm text-gray-700 mt-2">
                                {inv.items.map((it, idx) => (
                                  <div key={idx}>
                                    ‚Ä¢ {it.product}: {it.quantity} pz + {it.freebies || 0} omaggi @ ‚Ç¨{it.priceGross} {it.discount > 0 && `(sconto ${it.discount}%)`}
                                  </div>
                                ))}
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => startEditInvoice(inv)} 
                                disabled={isLoading} 
                                className="w-9 h-9 flex items-center justify-center text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-all"
                                title="Modifica fattura"
                              >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                                </svg>
                              </button>
                              <button 
                                onClick={() => deleteInvoice(inv.id)} 
                                disabled={isLoading} 
                                className="w-9 h-9 flex items-center justify-center text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all"
                                title="Elimina fattura"
                              >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* NOTE DI CREDITO */}
                {activeTab === 'credits' && (
                  <div className="space-y-6 sm:space-y-8">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Aggiungi Nota</h2>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-6 max-w-lg">
                        <div>
                          <label className="block text-sm font-medium mb-1">Data</label>
                          <div className="flex justify-center sm:justify-start">
                            <input type="date" value={creditDate} onChange={e => setCreditDate(e.target.value)} className="w-full px-3 sm:px-4 py-2 border rounded-lg text-sm sm:text-base" />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Importo ‚Ç¨</label>
                          <input type="number" step="0.01" value={creditAmount} onChange={e => setCreditAmount(e.target.value)} placeholder="es. 250.00" className="w-full px-3 sm:px-4 py-2 border rounded-lg text-sm sm:text-base" />
                        </div>
                      </div>
                      <button onClick={saveCreditNote} disabled={isLoading} className="flex items-center justify-center gap-2 mt-6 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-all shadow-sm hover:shadow w-full sm:w-auto">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                        </svg>
                        Salva Nota
                      </button>
                    </div>
                    
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold mb-4">Note di Credito ({creditNotes.length})</h2>
                      <div className="space-y-3">
                        {creditNotes.slice().sort((a, b) => {
                          const dateA = a.date || String(a.year);
                          const dateB = b.date || String(b.year);
                          return dateB.localeCompare(dateA);
                        }).map(note => (
                          <div key={note.id} className="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50">
                            <div className="font-medium text-lg">{note.date || note.year} - ‚Ç¨ {note.amount.toFixed(2)}</div>
                            <button 
                              onClick={() => deleteCreditNote(note.id)} 
                              disabled={isLoading} 
                              className="w-9 h-9 flex items-center justify-center text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all"
                              title="Elimina nota di credito"
                            >
                              <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                              </svg>
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* PREZZI ONLINE */}
                {activeTab === 'prices' && (
                  <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Prezzi Online</h2>
                    <p className="text-gray-600 mb-4 sm:mb-6 text-sm sm:text-base">I prezzi si salvano automaticamente dopo 2 secondi.</p>
                    
                    {/* LAYOUT MOBILE - Cards */}
                    <div className="grid grid-cols-1 gap-3 sm:hidden">
                      {PRODUCTS.map(product => (
                        <div key={product} className="border rounded-lg p-3 bg-gray-50">
                          <label className="block text-sm font-medium mb-2 text-gray-700">{product}</label>
                          <div className="flex items-center gap-2">
                            <input
                              type="number"
                              step="0.01"
                              value={onlinePrices[product] || ''}
                              onChange={e => handlePriceChange(product, e.target.value)}
                              placeholder="0.00"
                              className="flex-1 px-3 py-2 border rounded-lg text-base"
                              disabled={isLoading}
                            />
                            <span className="text-gray-500 font-medium">‚Ç¨</span>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    {/* LAYOUT DESKTOP - Inline */}
                    <div className="hidden sm:grid sm:grid-cols-1 md:grid-cols-2 gap-4">
                      {PRODUCTS.map(product => (
                        <div key={product} className="flex items-center gap-4">
                          <label className="w-64 text-sm font-medium truncate">{product}</label>
                          <input
                            type="number"
                            step="0.01"
                            value={onlinePrices[product] || ''}
                            onChange={e => handlePriceChange(product, e.target.value)}
                            placeholder="0.00"
                            className="flex-1 px-4 py-2 border rounded-lg"
                            disabled={isLoading}
                          />
                          <span className="text-gray-500">‚Ç¨</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
